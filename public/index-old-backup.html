<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Text2PPT Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
        }
        
        .header h1 {
            font-size: 3.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header p {
            font-size: 1.25rem;
            opacity: 0.95;
        }
        
        .badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            align-items: start;
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        
        .card h2 {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 1rem;
        }
        
        .api-section {
            background: #f8f9ff;
            border: 2px solid #e0e7ff;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .api-section.active {
            background: #e7f5e7;
            border-color: #4caf50;
        }
        
        .api-section h3 {
            font-size: 1rem;
            margin-bottom: 0.75rem;
            color: #555;
        }
        
        .info-box {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            border-radius: 4px;
        }
        
        .info-box strong {
            display: block;
            margin-bottom: 0.25rem;
        }
        
        .info-box ol {
            margin-left: 1.25rem;
            line-height: 1.6;
        }
        
        .info-box a {
            color: #1976d2;
            text-decoration: none;
            font-weight: 600;
        }
        
        .input-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        input[type="password"], input[type="text"] {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #e0e7ff;
            color: #667eea;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #d0d9ff;
            transform: translateY(-1px);
        }
        
        .btn-secondary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-generate {
            padding: 1.25rem;
            font-size: 1.1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-generate:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-generate:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        textarea {
            width: 100%;
            height: 400px;
            padding: 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            font-size: 0.95rem;
            resize: vertical;
            line-height: 1.6;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .status {
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-weight: 500;
        }
        
        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #2196f3;
        }
        
        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }
        
        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }
        
        .preview {
            overflow-y: auto;
            padding: 0.5rem;
            max-height: calc(100vh - 250px);
            min-height: 600px;
        }
        
        .preview::-webkit-scrollbar {
            width: 10px;
        }
        
        .preview::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .preview::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }
        
        .preview::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }
        
        .content-textarea {
            height: 400px;
        }
        
        .card-with-flex {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .preview-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            max-height: calc(100vh - 200px);
        }
        
        .preview-container h2 {
            flex-shrink: 0;
        }
        
        .preview-container .preview {
            flex: 1;
            min-height: 0;
        }
        
        .preview:empty::before {
            content: '';
            display: block;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 150"><text x="100" y="70" font-size="48" text-anchor="middle" fill="%23ccc">üìä</text><text x="100" y="100" font-size="14" text-anchor="middle" fill="%23999">Preview will appear here</text><text x="100" y="120" font-size="12" text-anchor="middle" fill="%23aaa">AI will design your slides</text></svg>') center/contain no-repeat;
        }
        
        .slide-preview {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            position: relative;
            overflow: hidden;
        }
        
        .slide-preview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background: linear-gradient(180deg, #F39C12 0%, #667eea 100%);
        }
        
        .slide-preview.title-slide {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 2rem 1rem;
        }
        
        .slide-preview.title-slide::before {
            display: none;
        }
        
        .slide-preview.title-slide::after {
            content: '';
            position: absolute;
            top: -30px;
            right: -30px;
            width: 120px;
            height: 120px;
            background: #F39C12;
            opacity: 0.2;
            border-radius: 50%;
        }
        
        .slide-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .slide-number {
            background: #667eea;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .slide-type {
            color: #666;
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        
        .title-slide .slide-type {
            color: rgba(255,255,255,0.8);
        }
        
        .slide-title {
            font-size: 1.125rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #333;
        }
        
        .title-slide .slide-title {
            color: white;
            font-size: 1.25rem;
        }
        
        .slide-content ul {
            margin-left: 1.25rem;
            line-height: 1.6;
        }
        
        .gallery-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            padding: 0.5rem;
        }
        
        .gallery-item {
            background: white;
            border: 2px solid #e0e7ff;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .gallery-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }
        
        .gallery-item img {
            width: 100%;
            height: auto;
            display: block;
            background: #f8f9fa;
        }
        
        .gallery-item-info {
            padding: 0.75rem;
            background: #f8f9ff;
        }
        
        .gallery-item-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .gallery-item-meta {
            font-size: 0.75rem;
            color: #666;
        }
        
        .view-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            background: #f0f4ff;
            padding: 0.5rem;
            border-radius: 8px;
        }
        
        .view-toggle button {
            flex: 1;
            padding: 0.5rem 1rem;
            border: 2px solid transparent;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.2s;
        }
        
        .view-toggle button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .view-toggle button:hover:not(.active) {
            border-color: #667eea;
            color: #667eea;
        }
        
        .theme-card {
            transition: all 0.3s ease;
        }
        
        .theme-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .settings-tab {
            transition: all 0.2s;
        }
        
        .settings-tab:hover {
            opacity: 0.9;
        }
        
        .prompt-editor {
            font-family: 'Courier New', Monaco, monospace;
            tab-size: 2;
        }
        
        .prompt-editor:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .example-btn {
            display: block;
            margin: 1rem auto 0;
            text-align: center;
            color: white;
            text-decoration: underline;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .example-btn:hover {
            opacity: 0.8;
        }
        
        .spinner {
            display: inline-block;
            width: 1em;
            height: 1em;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 0.75s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .progress-container {
            margin: 1rem 0;
            background: #f0f4ff;
            border-radius: 12px;
            padding: 1rem;
            border: 2px solid #e0e7ff;
        }
        
        .progress-bar-wrapper {
            background: #e0e7ff;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            position: relative;
            margin-bottom: 0.5rem;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .progress-steps {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.5rem;
        }
        
        .progress-step {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .progress-step.active {
            color: #667eea;
            font-weight: 600;
        }
        
        .progress-step.completed {
            color: #4caf50;
        }
        
        .footer {
            text-align: center;
            color: white;
            font-size: 0.9rem;
            margin-top: 2rem;
            opacity: 0.9;
        }
        
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé® AI Text2PPT Pro</h1>
            <p>Professional presentations powered by Claude AI</p>
            <span class="badge">Using html2pptx + PptxGenJS</span>
        </div>

        <div class="main-grid">
            <div class="card">
                <h2>üìù Your Content</h2>
                
                <!-- AI Idea Generation Section -->
                <div style="background: #f0fff4; border: 2px solid #86efac; border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                    <h3 style="font-size: 1.1rem; margin-bottom: 0.75rem; color: #555;">üí° AI Idea Generator</h3>
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 0.75rem;">Let AI expand your idea into detailed presentation content. Describe your topic or upload files.</p>
                    
                    <!-- Quick Example Templates -->
                    <div style="background: #fff; border: 1px solid #d1fae5; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem;">
                        <p style="font-size: 0.8rem; color: #555; margin-bottom: 0.5rem; font-weight: 600;">Quick Start Examples:</p>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.4rem;">
                            <button class="btn-secondary" onclick="loadExampleByCategory('tech')" style="padding: 0.4rem; font-size: 0.75rem;">
                                üíª Tech
                            </button>
                            <button class="btn-secondary" onclick="loadExampleByCategory('business')" style="padding: 0.4rem; font-size: 0.75rem;">
                                üíº Business
                            </button>
                            <button class="btn-secondary" onclick="loadExampleByCategory('education')" style="padding: 0.4rem; font-size: 0.75rem;">
                                üìö Education
                            </button>
                            <button class="btn-secondary" onclick="loadExampleByCategory('health')" style="padding: 0.4rem; font-size: 0.75rem;">
                                üè• Healthcare
                            </button>
                            <button class="btn-secondary" onclick="loadExampleByCategory('marketing')" style="padding: 0.4rem; font-size: 0.75rem;">
                                üìà Marketing
                            </button>
                            <button class="btn-secondary" onclick="loadExampleByCategory('environment')" style="padding: 0.4rem; font-size: 0.75rem;">
                                üåç Environment
                            </button>
                        </div>
                    </div>
                    
                    <!-- Idea Input -->
                    <textarea id="ideaInput" style="width: 100%; height: 100px; padding: 0.75rem; border: 2px solid #ddd; border-radius: 8px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; font-size: 0.9rem; resize: vertical; line-height: 1.5; margin-bottom: 0.75rem;">Create a quarterly business review presentation for Q4 2024 showing sales performance, market trends, and strategic initiatives for the executive team.</textarea>
                    
                    <!-- File Upload -->
                    <div style="margin-bottom: 0.75rem;">
                        <label style="display: block; font-size: 0.8rem; color: #555; margin-bottom: 0.25rem;">üìé Or upload files (PDF, DOC, TXT, PPT):</label>
                        <input type="file" id="fileUpload" multiple accept=".txt,.pdf,.doc,.docx,.md,.pptx" style="font-size: 0.8rem; width: 100%; margin-bottom: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; background: #f0f4ff; border-radius: 8px; border: 2px solid #e0e7ff; margin-bottom: 0.5rem;">
                            <input type="checkbox" id="extractColors" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-size: 0.8rem; color: #555;">
                                <strong>üé® Extract color theme from uploaded files</strong>
                                <span style="display: block; font-size: 0.7rem; color: #666; margin-top: 0.15rem;">
                                    Automatically detect and use colors from your documents
                                </span>
                            </span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; background: #fff4e6; border-radius: 8px; border: 2px solid #ffd699;">
                            <input type="checkbox" id="useAsTemplate" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-size: 0.8rem; color: #555;">
                                <strong>üìÑ Use uploaded PPTX as template/base</strong>
                                <span style="display: block; font-size: 0.7rem; color: #666; margin-top: 0.15rem;">
                                    Modify existing slides or add new content to uploaded PowerPoint
                                </span>
                            </span>
                        </label>
                    </div>
                    
                    <!-- Generation Options -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.75rem;">
                        <div>
                            <label style="display: block; font-size: 0.8rem; color: #555; margin-bottom: 0.25rem;">Number of slides:</label>
                            <input type="number" id="numSlides" value="6" min="3" max="20" style="width: 100%; padding: 0.5rem; border: 2px solid #ddd; border-radius: 8px; font-size: 0.85rem;">
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem;">
                                <input type="checkbox" id="generateImages" style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="font-size: 0.8rem; color: #555;">Generate AI images</span>
                            </label>
                        </div>
                    </div>
                    
                    <button class="btn-primary" onclick="generateFromPrompt()" id="promptBtn" style="width: 100%; padding: 0.75rem;">
                        üöÄ Expand Idea into Full Content
                    </button>
                    <p style="font-size: 0.75rem; color: #666; margin-top: 0.5rem; text-align: center; font-style: italic;">This creates detailed text content that you can edit below before generating slides</p>
                </div>
                
                <!-- Main Content Editor -->
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.9rem; color: #555; margin-bottom: 0.5rem; font-weight: 600;">üìù Presentation Content (edit as needed):</label>
                    <textarea id="textInput" class="content-textarea" placeholder="Your expanded content will appear here after clicking 'Expand Idea into Full Content' above, or you can type/paste your presentation content directly here..."></textarea>
                </div>
                
                <div id="status"></div>
                
                <!-- Progress Bar -->
                <div id="progressContainer" style="display: none;">
                    <div class="progress-container">
                        <div class="progress-bar-wrapper">
                            <div id="progressBar" class="progress-bar" style="width: 0%;">
                                <span id="progressText">0%</span>
                            </div>
                        </div>
                        <div class="progress-steps">
                            <div class="progress-step" id="step1">
                                <span>‚è≥</span> <span>Analyzing...</span>
                            </div>
                            <div class="progress-step" id="step2">
                                <span>üé®</span> <span>Designing...</span>
                            </div>
                            <div class="progress-step" id="step3">
                                <span>üìä</span> <span>Creating...</span>
                            </div>
                            <div class="progress-step" id="step4">
                                <span>‚ú®</span> <span>Finalizing...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 1rem;">
                    <button class="btn-secondary" onclick="generatePreview()" id="previewBtn" style="padding: 1rem; font-size: 1rem; font-weight: 600;">
                        üëÅÔ∏è Preview Slides
                    </button>
                    <button class="btn-generate" onclick="generatePresentation()" id="generateBtn" style="margin-top: 0; padding: 1rem; font-size: 1rem;">
                        ‚ú® Generate PowerPoint
                    </button>
                </div>
            </div>

            <div class="card preview-container">
                <h2>üëÅÔ∏è Slide Preview</h2>
                
                <!-- Color Theme Selector -->
                <div id="themeSelector" style="display: none; margin-bottom: 1rem;">
                    <div style="background: #f0fff4; border: 2px solid #82C341; border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                            <h3 style="font-size: 0.95rem; margin: 0; color: #555;">üé® Choose Color Theme</h3>
                            <span id="suggestedBadge" style="background: #82C341; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">AI Suggested</span>
                        </div>
                        <p style="font-size: 0.8rem; color: #666; margin: 0 0 1rem 0;">Select a color palette to customize your presentation's look and feel</p>
                        
                        <div id="themeGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.75rem;">
                            <!-- Theme cards will be inserted here -->
                        </div>
                    </div>
                </div>
                
                <div class="view-toggle" id="viewToggle" style="display: none;">
                    <button class="active" onclick="switchView('list')" id="listViewBtn">
                        üìã List View
                    </button>
                    <button onclick="switchView('gallery')" id="galleryViewBtn">
                        üñºÔ∏è Gallery View
                    </button>
                </div>
                <div class="preview" id="preview"></div>
            </div>
        </div>

        <div class="card" id="apiCard" style="margin-top: 1.5rem;">
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 2px solid #e0e7ff; padding-bottom: 0.5rem;">
                <button class="settings-tab active" onclick="switchSettingsTab('api')" id="tab-api" style="flex: 1; padding: 0.75rem; border: none; background: #667eea; color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    üîë API Keys
                </button>
                <button class="settings-tab" onclick="switchSettingsTab('prompts')" id="tab-prompts" style="flex: 1; padding: 0.75rem; border: none; background: #e0e7ff; color: #667eea; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    üìù AI Prompts
                </button>
            </div>
            
            <div id="apiSettingsContent">
                <h2 onclick="toggleApiSection()" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; margin-top: 0;">
                    <span>üîë API Configuration</span>
                    <span id="apiToggleIcon" style="font-size: 1.2rem;">‚ñº</span>
                </h2>
            
            <div id="apiSectionContainer" style="margin-top: 1rem;">
                <!-- Provider Selection -->
                <div style="background: #f0f4ff; border: 2px solid #e0e7ff; border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                    <h3 style="font-size: 1rem; margin-bottom: 0.75rem; color: #555;">Select AI Provider</h3>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;">
                        <button class="provider-btn active" onclick="selectProvider('anthropic')" id="provider-anthropic" style="padding: 0.75rem; border: 2px solid #667eea; background: #e0e7ff; border-radius: 8px; cursor: pointer; font-weight: 600; color: #667eea;">
                            Anthropic
                        </button>
                        <button class="provider-btn" onclick="selectProvider('openai')" id="provider-openai" style="padding: 0.75rem; border: 2px solid #ddd; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; color: #666;">
                            OpenAI
                        </button>
                        <button class="provider-btn" onclick="selectProvider('gemini')" id="provider-gemini" style="padding: 0.75rem; border: 2px solid #ddd; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; color: #666;">
                            Gemini
                        </button>
                        <button class="provider-btn" onclick="selectProvider('openrouter')" id="provider-openrouter" style="padding: 0.75rem; border: 2px solid #ddd; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; color: #666;">
                            OpenRouter
                        </button>
                    </div>
                </div>

                <!-- Anthropic Section -->
                <div class="api-section provider-section" id="section-anthropic">
                    <h3>Anthropic Claude API</h3>
                    <div class="info-box">
                        <strong>To get your API key:</strong>
                        <ol>
                            <li>Go to <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a></li>
                            <li>Sign up or log in</li>
                            <li>Navigate to "API Keys"</li>
                            <li>Create and copy your key</li>
                        </ol>
                    </div>
                    <div class="input-group">
                        <input type="password" id="apiKey-anthropic" placeholder="sk-ant-api03-...">
                        <button class="btn-primary" onclick="saveApiKey('anthropic')">Save Key</button>
                    </div>
                </div>

                <!-- OpenAI Section -->
                <div class="api-section provider-section" id="section-openai" style="display: none;">
                    <h3>OpenAI API</h3>
                    <div class="info-box">
                        <strong>To get your API key:</strong>
                        <ol>
                            <li>Go to <a href="https://platform.openai.com/" target="_blank">platform.openai.com</a></li>
                            <li>Sign up or log in</li>
                            <li>Navigate to "API Keys"</li>
                            <li>Create and copy your key</li>
                        </ol>
                    </div>
                    <div class="input-group">
                        <input type="password" id="apiKey-openai" placeholder="sk-...">
                        <button class="btn-primary" onclick="saveApiKey('openai')">Save Key</button>
                    </div>
                </div>

                <!-- Gemini Section -->
                <div class="api-section provider-section" id="section-gemini" style="display: none;">
                    <h3>Google Gemini API</h3>
                    <div class="info-box">
                        <strong>To get your API key:</strong>
                        <ol>
                            <li>Go to <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a></li>
                            <li>Sign up or log in</li>
                            <li>Click "Create API Key"</li>
                            <li>Copy your key</li>
                        </ol>
                    </div>
                    <div class="input-group">
                        <input type="password" id="apiKey-gemini" placeholder="AIza...">
                        <button class="btn-primary" onclick="saveApiKey('gemini')">Save Key</button>
                    </div>
                </div>

                <!-- OpenRouter Section -->
                <div class="api-section provider-section" id="section-openrouter" style="display: none;">
                    <h3>OpenRouter API</h3>
                    <div class="info-box">
                        <strong>To get your API key:</strong>
                        <ol>
                            <li>Go to <a href="https://openrouter.ai/" target="_blank">openrouter.ai</a></li>
                            <li>Sign up or log in</li>
                            <li>Navigate to "Keys"</li>
                            <li>Create and copy your key</li>
                        </ol>
                    </div>
                    <div class="input-group">
                        <input type="password" id="apiKey-openrouter" placeholder="sk-or-...">
                        <button class="btn-primary" onclick="saveApiKey('openrouter')">Save Key</button>
                    </div>
                </div>
            </div>
            </div>
            
            <!-- AI Prompts Editor Tab -->
            <div id="promptsSettingsContent" style="display: none;">
                <h2 style="margin-top: 0;">üìù AI Prompt Customization</h2>
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">Customize the AI prompts used for content generation, slide design, and file processing. All prompts are automatically backed up before changes.</p>
                
                <div id="promptEditorContainer">
                    <div style="text-align: center; padding: 2rem;">
                        <button class="btn-primary" onclick="showPromptEditor()" style="padding: 1rem 2rem;">
                            üìù Open Prompt Editor
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Professional presentations ‚Ä¢ Claude AI content structuring ‚Ä¢ html2pptx rendering</p>
            <p style="font-size: 0.8rem; margin-top: 0.5rem;">All processing happens on your server ‚Ä¢ Your API key is stored locally</p>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script src="/js/ui.js"></script>
    <script src="/js/charts.js"></script>
    <script src="/js/themes.js"></script>
    <script src="/js/fileHandler.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/preview.js"></script>
    <script src="/js/promptEditor.js"></script>
    
    <script>
        // Global variable to store slide data
        let currentSlideData = null;
        let currentProvider = 'anthropic';
        let currentView = 'list';
        let selectedTheme = null;
        
        /**
         * Switches between API and Prompts settings tabs
         * @param {string} tab - Tab name: 'api' or 'prompts'
         */
        function switchSettingsTab(tab) {
            // Update tab button styles
            document.querySelectorAll('.settings-tab').forEach(btn => {
                btn.style.background = '#e0e7ff';
                btn.style.color = '#667eea';
            });
            
            const activeTab = document.getElementById(`tab-${tab}`);
            if (activeTab) {
                activeTab.style.background = '#667eea';
                activeTab.style.color = 'white';
            }
            
            // Show/hide content
            document.getElementById('apiSettingsContent').style.display = tab === 'api' ? 'block' : 'none';
            document.getElementById('promptsSettingsContent').style.display = tab === 'prompts' ? 'block' : 'none';
        }

        // Predefined color themes
        const colorThemes = {
            'corporate-blue': {
                name: 'Corporate Blue',
                description: 'Professional and trustworthy',
                colorPrimary: '#1C2833',
                colorSecondary: '#2E4053',
                colorAccent: '#3498DB',
                colorBackground: '#FFFFFF',
                colorText: '#1d1d1d',
                category: ['business', 'corporate', 'finance']
            },
            'vibrant-purple': {
                name: 'Vibrant Purple',
                description: 'Creative and innovative',
                colorPrimary: '#667eea',
                colorSecondary: '#764ba2',
                colorAccent: '#F39C12',
                colorBackground: '#FFFFFF',
                colorText: '#1d1d1d',
                category: ['tech', 'creative', 'marketing']
            },
            'forest-green': {
                name: 'Forest Green',
                description: 'Sustainable and growth-focused',
                colorPrimary: '#1E5631',
                colorSecondary: '#2D7F4B',
                colorAccent: '#82C341',
                colorBackground: '#FFFFFF',
                colorText: '#1d1d1d',
                category: ['environment', 'health', 'sustainability']
            },
            'ocean-teal': {
                name: 'Ocean Teal',
                description: 'Modern and fresh',
                colorPrimary: '#006B7D',
                colorSecondary: '#00A1B3',
                colorAccent: '#FF6B6B',
                colorBackground: '#FFFFFF',
                colorText: '#1d1d1d',
                category: ['tech', 'healthcare', 'education']
            },
            'sunset-orange': {
                name: 'Sunset Orange',
                description: 'Energetic and dynamic',
                colorPrimary: '#D64933',
                colorSecondary: '#E67E50',
                colorAccent: '#FFA826',
                colorBackground: '#FFFFFF',
                colorText: '#1d1d1d',
                category: ['marketing', 'retail', 'creative']
            },
            'royal-burgundy': {
                name: 'Royal Burgundy',
                description: 'Elegant and sophisticated',
                colorPrimary: '#6B2737',
                colorSecondary: '#8B3A52',
                colorAccent: '#C89B3C',
                colorBackground: '#FFFFFF',
                colorText: '#1d1d1d',
                category: ['luxury', 'finance', 'executive']
            },
            'midnight-navy': {
                name: 'Midnight Navy',
                description: 'Authoritative and confident',
                colorPrimary: '#1A2332',
                colorSecondary: '#2C3E50',
                colorAccent: '#E74C3C',
                colorBackground: '#FFFFFF',
                colorText: '#1d1d1d',
                category: ['business', 'consulting', 'corporate']
            },
            'sage-olive': {
                name: 'Sage Olive',
                description: 'Calm and balanced',
                colorPrimary: '#4A5D4F',
                colorSecondary: '#6B8E73',
                colorAccent: '#D4A574',
                colorBackground: '#FFFFFF',
                colorText: '#1d1d1d',
                category: ['wellness', 'education', 'nonprofit']
            }
        };

        // Load API keys and provider from localStorage
        window.addEventListener('load', () => {
            // Load saved provider
            const savedProvider = localStorage.getItem('ai_provider') || 'anthropic';
            currentProvider = savedProvider;
            selectProvider(savedProvider);
            
            // Load all saved keys
            ['anthropic', 'openai', 'gemini', 'openrouter'].forEach(provider => {
                const savedKey = localStorage.getItem(`${provider}_api_key`);
                if (savedKey) {
                    document.getElementById(`apiKey-${provider}`).value = savedKey;
                }
            });
            
            // Check if collapsed state was saved
            const isCollapsed = localStorage.getItem('api_section_collapsed') === 'true';
            if (isCollapsed) {
                toggleApiSection();
            }
        });

        function toggleApiSection() {
            const container = document.getElementById('apiSectionContainer');
            const icon = document.getElementById('apiToggleIcon');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                icon.textContent = '‚ñº';
                localStorage.setItem('api_section_collapsed', 'false');
            } else {
                container.style.display = 'none';
                icon.textContent = '‚ñ∂';
                localStorage.setItem('api_section_collapsed', 'true');
            }
        }

        function selectProvider(provider) {
            currentProvider = provider;
            localStorage.setItem('ai_provider', provider);
            
            // Update button styles
            document.querySelectorAll('.provider-btn').forEach(btn => {
                btn.style.border = '2px solid #ddd';
                btn.style.background = 'white';
                btn.style.color = '#666';
            });
            
            const activeBtn = document.getElementById(`provider-${provider}`);
            activeBtn.style.border = '2px solid #667eea';
            activeBtn.style.background = '#e0e7ff';
            activeBtn.style.color = '#667eea';
            
            // Show/hide sections
            document.querySelectorAll('.provider-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(`section-${provider}`).style.display = 'block';
        }

        function saveApiKey(provider) {
            const apiKey = document.getElementById(`apiKey-${provider}`).value.trim();
            if (!apiKey) {
                showStatus('Please enter your API key', 'error');
                return;
            }
            localStorage.setItem(`${provider}_api_key`, apiKey);
            showStatus(`‚úÖ ${provider.charAt(0).toUpperCase() + provider.slice(1)} API key saved!`, 'success');
        }

        function getApiKey() {
            return localStorage.getItem(`${currentProvider}_api_key`);
        }

        // Generate preview of slides
        async function generatePreview() {
            const text = document.getElementById('textInput').value.trim();
            const apiKey = getApiKey();
            
            if (!apiKey) {
                showStatus('‚ö†Ô∏è Please enter your API key first!', 'error');
                return;
            }
            
            if (!text) {
                showStatus('‚ö†Ô∏è Please enter some text!', 'error');
                return;
            }
            
            const previewBtn = document.getElementById('previewBtn');
            previewBtn.disabled = true;
            previewBtn.innerHTML = '<span class="spinner"></span> Generating preview...';
            
            // Show progress
            showProgress();
            updateProgress(10, 'step1');
            
            showStatus('ü§ñ AI is analyzing your content...', 'info');
            document.getElementById('preview').innerHTML = '<div style="text-align: center; padding: 2rem;"><span class="spinner" style="width: 2rem; height: 2rem; border-width: 3px;"></span><p style="margin-top: 1rem; color: #666;">AI is designing your slides...</p></div>';
            
            try {
                updateProgress(25, 'step1');
                
                const response = await fetch('/api/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text, apiKey, provider: currentProvider })
                });
                
                updateProgress(60, 'step2');
                
                if (!response.ok) {
                    let errorMessage = 'Preview generation failed';
                    try {
                    const error = await response.json();
                        errorMessage = error.error || errorMessage;
                    } catch (e) {
                        errorMessage = `Server error: ${response.status} ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                
                updateProgress(80, 'step3');
                const slideData = await response.json();
                currentSlideData = slideData;
                
                // Determine suggested theme based on content or AI suggestion
                let suggestedTheme = slideData.suggestedThemeKey || 'vibrant-purple'; // Default fallback
                
                // If user extracted colors from files, use that theme
                if (selectedTheme === 'extracted-custom' && colorThemes['extracted-custom']) {
                    suggestedTheme = 'extracted-custom';
                    currentSlideData.designTheme = {
                        ...colorThemes['extracted-custom'],
                        name: colorThemes['extracted-custom'].name,
                        description: colorThemes['extracted-custom'].description
                    };
                } else {
                    // If AI didn't suggest a theme, try to match based on theme name
                    if (!suggestedTheme && slideData.designTheme) {
                        // Try to find matching theme by name
                        const themeName = slideData.designTheme.name.toLowerCase();
                        for (const [key, theme] of Object.entries(colorThemes)) {
                            if (themeName.includes(key.split('-')[0]) || themeName.includes(key.split('-')[1])) {
                                suggestedTheme = key;
                                break;
                            }
                        }
                    }
                    
                    // Apply suggested theme if no theme selected yet
                    if (!selectedTheme && suggestedTheme && colorThemes[suggestedTheme]) {
                        currentSlideData.designTheme = {
                            ...colorThemes[suggestedTheme],
                            name: colorThemes[suggestedTheme].name,
                            description: colorThemes[suggestedTheme].description
                        };
                    }
                }
                
                // Store suggested theme
                currentSlideData.suggestedTheme = suggestedTheme;
                
                // Display theme selector
                displayThemeSelector(suggestedTheme);
                
                // Display preview
                displayPreview(slideData);
                updateProgress(100, 'step4');
                
                setTimeout(() => {
                    if (templateFile) {
                        showStatus(`‚úÖ Preview ready! Using ${templateFile.name} as template. Click "Generate PowerPoint" to create.`, 'success');
                    } else {
                        showStatus('‚úÖ Preview ready! Choose a color theme above or click "Generate PowerPoint".', 'success');
                    }
                    hideProgress();
                }, 500);
                
            } catch (error) {
                console.error('Preview Error:', error);
                document.getElementById('preview').innerHTML = '';
                hideProgress();
                
                // Check for network errors
                if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
                    showStatus('‚ùå Connection error. Make sure the server is running on http://localhost:3000', 'error');
                } else if (error.message.includes('401') || error.message.includes('authentication')) {
                    showStatus('‚ùå Invalid API key. Please check and try again.', 'error');
                } else {
                    showStatus('‚ùå Error: ' + error.message, 'error');
                }
            } finally {
                previewBtn.disabled = false;
                previewBtn.innerHTML = 'üëÅÔ∏è Preview Slides';
            }
        }

        function displayThemeSelector(suggestedThemeKey) {
            const themeGrid = document.getElementById('themeGrid');
            const themeSelector = document.getElementById('themeSelector');
            const suggestedBadge = document.getElementById('suggestedBadge');
            
            themeGrid.innerHTML = '';
            
            // Show the theme selector
            themeSelector.style.display = 'block';
            
            // Update suggested badge
            if (suggestedThemeKey && colorThemes[suggestedThemeKey]) {
                suggestedBadge.textContent = `‚ú® ${colorThemes[suggestedThemeKey].name} Suggested`;
                suggestedBadge.style.display = 'inline-block';
            } else {
                suggestedBadge.style.display = 'none';
            }
            
            // Create theme cards
            Object.keys(colorThemes).forEach(themeKey => {
                const theme = colorThemes[themeKey];
                const isSuggested = themeKey === suggestedThemeKey;
                const isSelected = selectedTheme === themeKey || (!selectedTheme && isSuggested);
                
                const card = document.createElement('div');
                card.className = 'theme-card';
                card.style.cssText = `
                    border: 2px solid ${isSelected ? theme.colorAccent : '#e0e7ff'};
                    border-radius: 8px;
                    padding: 0.75rem;
                    cursor: pointer;
                    transition: all 0.2s;
                    background: ${isSelected ? theme.colorPrimary + '10' : 'white'};
                    position: relative;
                `;
                
                const isExtracted = theme.isExtracted || false;
                
                card.innerHTML = `
                    ${isExtracted ? '<div style="position: absolute; top: 0.25rem; right: 0.25rem; background: #667eea; color: white; padding: 0.15rem 0.4rem; border-radius: 8px; font-size: 0.65rem; font-weight: 600;">üìÅ From Files</div>' : (isSuggested && !selectedTheme ? '<div style="position: absolute; top: 0.25rem; right: 0.25rem; background: #82C341; color: white; padding: 0.15rem 0.4rem; border-radius: 8px; font-size: 0.65rem; font-weight: 600;">‚ú® Suggested</div>' : '')}
                    <div style="display: flex; gap: 0.25rem; margin-bottom: 0.5rem;">
                        <div style="flex: 1; height: 30px; background: ${theme.colorPrimary}; border-radius: 4px;"></div>
                        <div style="flex: 1; height: 30px; background: ${theme.colorSecondary}; border-radius: 4px;"></div>
                        <div style="flex: 1; height: 30px; background: ${theme.colorAccent}; border-radius: 4px;"></div>
                    </div>
                    <div style="font-weight: 600; font-size: 0.85rem; color: #333; margin-bottom: 0.25rem;">${theme.name}</div>
                    <div style="font-size: 0.7rem; color: #666;">${theme.description}</div>
                    ${isSelected ? '<div style="margin-top: 0.5rem; text-align: center; color: ' + theme.colorPrimary + '; font-size: 0.75rem; font-weight: 600;">‚úì Selected</div>' : ''}
                `;
                
                card.onclick = () => selectTheme(themeKey);
                themeGrid.appendChild(card);
            });
        }

        function selectTheme(themeKey) {
            selectedTheme = themeKey;
            
            // Update the slideData with new theme
            if (currentSlideData) {
                currentSlideData.designTheme = {
                    ...colorThemes[themeKey],
                    name: colorThemes[themeKey].name,
                    description: colorThemes[themeKey].description
                };
                
                // Re-display theme selector with updated selection
                const suggestedTheme = currentSlideData.suggestedTheme || null;
                displayThemeSelector(suggestedTheme);
                
                // Re-render preview
                displayPreview(currentSlideData);
                
                showStatus(`‚ú® Theme changed to ${colorThemes[themeKey].name}. Click "Generate PowerPoint" to create with new colors.`, 'success');
            }
        }

        function switchView(view) {
            currentView = view;
            
            // Update button states
            const listBtn = document.getElementById('listViewBtn');
            const galleryBtn = document.getElementById('galleryViewBtn');
            
            if (view === 'list') {
                listBtn.classList.add('active');
                galleryBtn.classList.remove('active');
            } else {
                listBtn.classList.remove('active');
                galleryBtn.classList.add('active');
            }
            
            // Re-render preview with current slide data
            if (currentSlideData) {
                displayPreview(currentSlideData);
            }
        }

        // Helper function to generate simple chart SVG
        function generateChartSVG(chart, theme, width = 400, height = 250) {
            const data = chart.data;
            const type = chart.type;
            const labels = data.labels;
            const datasets = data.datasets;
            
            if (type === 'bar' || type === 'column') {
                const maxValue = Math.max(...datasets.flatMap(d => d.values));
                const barWidth = (width - 100) / (labels.length * datasets.length + labels.length);
                const groupWidth = barWidth * datasets.length;
                
                let svg = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">`;
                
                // Bars
                datasets.forEach((dataset, datasetIdx) => {
                    const colors = ['#667eea', '#764ba2', '#f39c12', '#2ecc71', '#e74c3c'];
                    const color = colors[datasetIdx % colors.length];
                    
                    dataset.values.forEach((value, i) => {
                        const barHeight = (value / maxValue) * (height - 60);
                        const x = 50 + i * (groupWidth + barWidth) + datasetIdx * barWidth;
                        const y = height - 40 - barHeight;
                        
                        svg += `<rect x="${x}" y="${y}" width="${barWidth - 2}" height="${barHeight}" fill="${color}" opacity="0.8"/>`;
                        svg += `<text x="${x + barWidth/2}" y="${y - 5}" text-anchor="middle" font-size="10" fill="#333">${value}</text>`;
                    });
                });
                
                // Labels
                labels.forEach((label, i) => {
                    const x = 50 + i * (groupWidth + barWidth) + groupWidth / 2;
                    svg += `<text x="${x}" y="${height - 20}" text-anchor="middle" font-size="11" fill="#666">${label}</text>`;
                });
                
                svg += '</svg>';
                return svg;
            } else if (type === 'line' || type === 'area') {
                const maxValue = Math.max(...datasets.flatMap(d => d.values));
                const stepX = (width - 100) / (labels.length - 1);
                
                let svg = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">`;
                
                datasets.forEach((dataset, datasetIdx) => {
                    const colors = ['#667eea', '#764ba2', '#f39c12'];
                    const color = colors[datasetIdx % colors.length];
                    
                    let path = '';
                    let areaPath = '';
                    
                    dataset.values.forEach((value, i) => {
                        const x = 50 + i * stepX;
                        const y = height - 40 - (value / maxValue) * (height - 60);
                        
                        if (i === 0) {
                            path = `M ${x} ${y}`;
                            areaPath = `M ${x} ${height - 40} L ${x} ${y}`;
                        } else {
                            path += ` L ${x} ${y}`;
                            areaPath += ` L ${x} ${y}`;
                        }
                        
                        // Data points
                        svg += `<circle cx="${x}" cy="${y}" r="4" fill="${color}"/>`;
                        svg += `<text x="${x}" y="${y - 10}" text-anchor="middle" font-size="10" fill="#333">${value}</text>`;
                    });
                    
                    if (type === 'area') {
                        areaPath += ` L ${50 + (labels.length - 1) * stepX} ${height - 40} Z`;
                        svg = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
                                <path d="${areaPath}" fill="${color}" opacity="0.2"/>
                                <path d="${path}" stroke="${color}" stroke-width="2" fill="none"/>` + svg.substring(svg.indexOf('<circle'));
                    } else {
                        svg += `<path d="${path}" stroke="${color}" stroke-width="2" fill="none"/>`;
                    }
                });
                
                // Labels
                labels.forEach((label, i) => {
                    const x = 50 + i * stepX;
                    svg += `<text x="${x}" y="${height - 20}" text-anchor="middle" font-size="11" fill="#666">${label}</text>`;
                });
                
                svg += '</svg>';
                return svg;
            } else if (type === 'pie') {
                const total = datasets[0].values.reduce((a, b) => a + b, 0);
                const centerX = width / 2;
                const centerY = height / 2;
                const radius = Math.min(width, height) / 2 - 40;
                
                let svg = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">`;
                const colors = ['#667eea', '#764ba2', '#f39c12', '#2ecc71', '#e74c3c', '#3498db'];
                
                let currentAngle = -90;
                
                datasets[0].values.forEach((value, i) => {
                    const angle = (value / total) * 360;
                    const endAngle = currentAngle + angle;
                    
                    const x1 = centerX + radius * Math.cos(currentAngle * Math.PI / 180);
                    const y1 = centerY + radius * Math.sin(currentAngle * Math.PI / 180);
                    const x2 = centerX + radius * Math.cos(endAngle * Math.PI / 180);
                    const y2 = centerY + radius * Math.sin(endAngle * Math.PI / 180);
                    
                    const largeArc = angle > 180 ? 1 : 0;
                    
                    svg += `<path d="M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z" fill="${colors[i % colors.length]}" opacity="0.8"/>`;
                    
                    // Label
                    const labelAngle = currentAngle + angle / 2;
                    const labelX = centerX + (radius * 0.7) * Math.cos(labelAngle * Math.PI / 180);
                    const labelY = centerY + (radius * 0.7) * Math.sin(labelAngle * Math.PI / 180);
                    const percentage = ((value / total) * 100).toFixed(0);
                    svg += `<text x="${labelX}" y="${labelY}" text-anchor="middle" font-size="12" font-weight="bold" fill="white">${percentage}%</text>`;
                    
                    currentAngle = endAngle;
                });
                
                // Legend
                let legendY = 20;
                labels.forEach((label, i) => {
                    svg += `<rect x="10" y="${legendY}" width="15" height="15" fill="${colors[i % colors.length]}"/>`;
                    svg += `<text x="30" y="${legendY + 12}" font-size="11" fill="#666">${label}</text>`;
                    legendY += 20;
                });
                
                svg += '</svg>';
                return svg;
            }
            
            return '<div>Chart preview not available</div>';
        }

        function displayPreview(slideData) {
            const preview = document.getElementById('preview');
            const theme = slideData.designTheme;
            
            // Show view toggle
            document.getElementById('viewToggle').style.display = 'flex';
            
            if (currentView === 'gallery') {
                displayGalleryView(slideData);
                return;
            }
            
            // List view (original)
            let html = '';
            
            // Show template indicator if using template
            if (templateFile) {
                html += `
                    <div style="background: #fff4e6; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #ffa826; border: 2px solid #ffd699;">
                        <strong style="color: #d97706;">üìÑ Template Mode Active</strong>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #666;">Using ${templateFile.name} as base. New slides will be added with AI content.</p>
                    </div>
                `;
            }
            
            html += `
                <div style="background: #f0f4ff; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid ${theme.colorPrimary};">
                    <strong style="color: ${theme.colorPrimary};">üé® ${theme.name}</strong>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #666;">${theme.description}</p>
                </div>
            `;
            
            slideData.slides.forEach((slide, index) => {
                const isTitle = slide.type === 'title';
                const bgColor = isTitle ? theme.colorPrimary : '#ffffff';
                const textColor = isTitle ? '#ffffff' : '#333';
                const borderColor = isTitle ? theme.colorPrimary : '#dee2e6';
                
                html += `
                    <div class="slide-preview ${isTitle ? 'title-slide' : ''}" style="background: ${bgColor}; border-color: ${borderColor}; padding-left: ${isTitle ? '1rem' : '1.5rem'};">
                        <div class="slide-header">
                            <span class="slide-number" style="background: ${theme.colorAccent};">Slide ${index + 1}</span>
                            <span class="slide-type" style="color: ${isTitle ? 'rgba(255,255,255,0.8)' : '#666'};">${slide.type === 'title' ? 'Title Slide' : slide.layout || 'Content'}</span>
                        </div>
                        ${!isTitle && slide.graphics?.icons?.[0]?.emoji ? `
                        <div style="display: inline-block; background: linear-gradient(135deg, ${theme.colorAccent} 0%, ${theme.colorPrimary} 50%); padding: 0.4rem 0.6rem; border-radius: 8px; margin-bottom: 0.5rem; font-size: 1.2rem;">
                            ${slide.graphics.icons[0].emoji}
                        </div>
                        ` : ''}
                        <div class="slide-title" style="color: ${textColor}; ${!isTitle ? 'display: flex; align-items: center; gap: 0.75rem;' : ''}">${slide.title}</div>
                `;
                
                if (slide.subtitle) {
                    html += `<div style="color: ${textColor}; opacity: 0.95; font-size: 0.9rem; margin-top: 0.5rem;">${slide.subtitle}</div>`;
                }
                
                if (isTitle) {
                    html += `<div style="width: 80px; height: 3px; background: ${theme.colorAccent}; margin: 1rem auto 0; border-radius: 2px;"></div>`;
                }
                
                if (slide.header) {
                    html += `<div style="background: ${isTitle ? 'rgba(255,255,255,0.1)' : 'linear-gradient(90deg, ' + theme.colorAccent + '20 0%, transparent 100%)'}; border-left: ${isTitle ? '3px solid rgba(255,255,255,0.5)' : '3px solid ' + theme.colorAccent}; color: ${isTitle ? 'rgba(255,255,255,0.95)' : theme.colorSecondary}; font-size: 0.85rem; margin-top: 0.5rem; padding: 0.5rem 0.75rem; border-radius: 0 6px 6px 0; font-style: italic;">${slide.header}</div>`;
                }
                
                if (slide.imageDescription) {
                    html += `<div style="background: #f0f4ff; border: 2px dashed ${theme.colorAccent}; padding: 0.5rem; margin-top: 0.5rem; border-radius: 4px; font-size: 0.75rem; color: #666; text-align: center;">üì∏ ${slide.imageDescription}</div>`;
                }
                
                if (slide.layout === 'chart' && slide.chart) {
                    // Chart slide
                    html += `
                        <div class="slide-content" style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                            <div style="flex: 1; background: #f8f9fa; border: 2px solid ${theme.colorAccent}; border-radius: 8px; padding: 1rem;">
                                <div style="font-weight: 600; color: ${theme.colorPrimary}; margin-bottom: 0.5rem; text-align: center;">üìä ${slide.chart.title}</div>
                                <div style="text-align: center;">
                                    ${generateChartSVG(slide.chart, theme, 350, 180)}
                                </div>
                            </div>
                            ${slide.content && slide.content.length > 0 ? `
                            <div style="flex: 0 0 200px;">
                                <div style="font-weight: 600; color: ${theme.colorSecondary}; font-size: 0.8rem; margin-bottom: 0.5rem;">Key Insights:</div>
                                <ul style="margin: 0; padding-left: 1rem; font-size: 0.75rem; line-height: 1.4;">
                                    ${slide.content.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}
                        </div>
                    `;
                } else if (slide.content && slide.content.length > 0) {
                    if (slide.layout === 'three-column') {
                        const third = Math.ceil(slide.content.length / 3);
                        const col1 = slide.content.slice(0, third);
                        const col2 = slide.content.slice(third, third * 2);
                        const col3 = slide.content.slice(third * 2);
                        
                        html += `
                            <div class="slide-content" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem; margin-top: 0.5rem;">
                                <ul style="margin: 0; padding-left: 1rem; font-size: 0.75rem; line-height: 1.3;">
                                    ${col1.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                                <ul style="margin: 0; padding-left: 1rem; font-size: 0.75rem; line-height: 1.3;">
                                    ${col2.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                                <ul style="margin: 0; padding-left: 1rem; font-size: 0.75rem; line-height: 1.3;">
                                    ${col3.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    } else if (slide.layout === 'two-column') {
                        const half = Math.ceil(slide.content.length / 2);
                        const col1 = slide.content.slice(0, half);
                        const col2 = slide.content.slice(half);
                        
                        html += `
                            <div class="slide-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
                                <ul style="margin: 0; padding-left: 1.25rem; font-size: 0.85rem; line-height: 1.4;">
                                    ${col1.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                                <ul style="margin: 0; padding-left: 1.25rem; font-size: 0.85rem; line-height: 1.4;">
                                    ${col2.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    } else if (slide.layout === 'framework') {
                        html += `
                            <div class="slide-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 0.5rem;">
                                ${slide.content.map(item => `
                                    <div style="background: #f8f9fa; border-left: 3px solid ${theme.colorAccent}; padding: 0.5rem; border-radius: 4px; font-size: 0.8rem; line-height: 1.4;">
                                        ${item}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else if (slide.layout === 'process-flow') {
                        html += `
                            <div class="slide-content" style="margin-top: 0.5rem;">
                                ${slide.content.map((item, idx) => `
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <span style="background: ${theme.colorAccent}; color: white; font-weight: bold; min-width: 1.5rem; height: 1.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">
                                            ${idx + 1}
                                        </span>
                                        <span style="flex: 1; background: linear-gradient(90deg, ${theme.colorPrimary}15 0%, ${theme.colorPrimary}05 100%); padding: 0.35rem 0.75rem; border-left: 2px solid ${theme.colorAccent}; font-size: 0.8rem; line-height: 1.3;">
                                            ${item}
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="slide-content">
                                <ul style="margin: 0.5rem 0 0 0; padding-left: 0; list-style: none; font-size: 0.85rem; line-height: 1.4;">
                                    ${slide.content.map((item, idx) => `
                                    <li style="display: flex; align-items: start; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <span style="flex-shrink: 0; width: 20px; height: 20px; background: linear-gradient(135deg, ${theme.colorAccent} 0%, ${theme.colorPrimary} 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">${idx + 1}</span>
                                        <span style="flex: 1; padding-top: 2px;">${item}</span>
                                    </li>
                                    `).join('')}
                                </ul>
                            </div>
                        `;
                    }
                }
                
                html += `</div>`;
            });
            
            preview.innerHTML = html;
        }

        function displayGalleryView(slideData) {
            const preview = document.getElementById('preview');
            const theme = slideData.designTheme;
            
            let html = `
                <div style="background: #f0f4ff; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid ${theme.colorPrimary};">
                    <strong style="color: ${theme.colorPrimary};">üé® ${theme.name}</strong>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: #666;">${theme.description}</p>
                </div>
                <div class="gallery-view">
            `;
            
            slideData.slides.forEach((slide, index) => {
                const isTitle = slide.type === 'title';
                const bgColor = isTitle ? theme.colorPrimary : '#ffffff';
                const textColor = isTitle ? '#ffffff' : '#333';
                const borderColor = isTitle ? theme.colorPrimary : '#e0e7ff';
                
                // Create a mini preview of the slide
                let slidePreviewHtml = '';
                
                if (isTitle) {
                    slidePreviewHtml = `
                        <div style="background: ${bgColor}; padding: 2rem; min-height: 150px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;">
                            <div style="color: ${textColor}; font-size: 1.25rem; font-weight: bold; margin-bottom: 0.5rem;">
                                ${slide.title}
                            </div>
                            ${slide.subtitle ? `<div style="color: ${textColor}; opacity: 0.9; font-size: 0.85rem;">${slide.subtitle}</div>` : ''}
                        </div>
                    `;
                } else if (slide.layout === 'chart' && slide.chart) {
                    // Chart slide preview
                    slidePreviewHtml = `
                        <div style="background: ${bgColor}; padding: 1rem; min-height: 150px; border: 1px solid ${borderColor}; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <div style="color: ${theme.colorPrimary}; font-size: 0.9rem; font-weight: bold; margin-bottom: 0.5rem; text-align: center;">
                                ${slide.title}
                            </div>
                            <div style="background: #f0f4ff; border: 2px dashed ${theme.colorAccent}; padding: 0.5rem; border-radius: 4px; text-align: center; width: 100%;">
                                üìä ${slide.chart.type.toUpperCase()} Chart<br/>
                                <span style="font-size: 0.7rem; color: #666;">${slide.chart.title}</span>
                            </div>
                            ${slide.content && slide.content.length > 0 ? `<div style="font-size: 0.65rem; color: #999; margin-top: 0.5rem;">${slide.content.length} insights</div>` : ''}
                        </div>
                    `;
                } else {
                    // Content slide preview
                    const contentPreview = slide.content ? slide.content.slice(0, 3).map(item => 
                        `<li style="font-size: 0.7rem; margin-bottom: 0.25rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item}</li>`
                    ).join('') : '';
                    
                    slidePreviewHtml = `
                        <div style="background: ${bgColor}; padding: 1rem; min-height: 150px; border: 1px solid ${borderColor};">
                            <div style="color: ${theme.colorPrimary}; font-size: 0.9rem; font-weight: bold; margin-bottom: 0.5rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${slide.title}
                            </div>
                            ${slide.header ? `<div style="color: ${theme.colorSecondary}; font-size: 0.65rem; margin-bottom: 0.5rem; font-style: italic; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${slide.header}</div>` : ''}
                            ${contentPreview ? `<ul style="margin: 0; padding-left: 1rem; list-style: circle;">${contentPreview}</ul>` : ''}
                            ${slide.content && slide.content.length > 3 ? `<div style="font-size: 0.65rem; color: #999; margin-top: 0.25rem;">+ ${slide.content.length - 3} more points...</div>` : ''}
                        </div>
                    `;
                }
                
                html += `
                    <div class="gallery-item" onclick="scrollToSlide(${index})">
                        ${slidePreviewHtml}
                        <div class="gallery-item-info">
                            <div class="gallery-item-title">Slide ${index + 1}: ${slide.title.length > 30 ? slide.title.substring(0, 30) + '...' : slide.title}</div>
                            <div class="gallery-item-meta">
                                ${slide.type === 'title' ? 'Title Slide' : (slide.layout || 'Content')}
                                ${slide.content ? ` ‚Ä¢ ${slide.content.length} points` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            preview.innerHTML = html;
        }

        function scrollToSlide(index) {
            // Switch to list view and scroll to the specific slide
            currentView = 'list';
            switchView('list');
            
            // Wait for the view to render, then scroll
            setTimeout(() => {
                const slides = document.querySelectorAll('.slide-preview');
                if (slides[index]) {
                    slides[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Highlight the slide temporarily
                    slides[index].style.boxShadow = '0 0 20px rgba(102, 126, 234, 0.5)';
                    setTimeout(() => {
                        slides[index].style.boxShadow = '';
                    }, 2000);
                }
            }, 100);
        }

        async function generatePresentation() {
            const text = document.getElementById('textInput').value.trim();
            const apiKey = getApiKey();
            
            if (!apiKey) {
                showStatus('‚ö†Ô∏è Please enter your API key first!', 'error');
                return;
            }
            
            if (!text) {
                showStatus('‚ö†Ô∏è Please enter some text!', 'error');
                return;
            }
            
            // If no preview generated yet, generate one first
            if (!currentSlideData) {
                await generatePreview();
                if (!currentSlideData) return; // Preview failed
            }
            
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Creating PowerPoint...';
            
            // Show progress
            showProgress();
            updateProgress(10, 'step1');
            showStatus('üìä Generating your professional PowerPoint...', 'info');
            
            try {
                updateProgress(30, 'step2');
                
                let response;
                
                // If using template, send as multipart form data
                if (templateFile) {
                    const formData = new FormData();
                    formData.append('templateFile', templateFile);
                    formData.append('text', text);
                    formData.append('apiKey', apiKey);
                    formData.append('provider', currentProvider);
                    formData.append('slideData', JSON.stringify(currentSlideData));
                    
                    response = await fetch('/api/generate-with-template', {
                        method: 'POST',
                        body: formData
                    });
                } else {
                    // Regular generation without template
                    response = await fetch('/api/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ text, apiKey, provider: currentProvider, slideData: currentSlideData })
                    });
                }
                
                updateProgress(70, 'step3');
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Generation failed');
                }
                
                updateProgress(90, 'step4');
                
                // Download the file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'AI-Presentation-Pro.pptx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                updateProgress(100, 'step4');
                
                setTimeout(() => {
                    showStatus('‚úÖ Professional presentation downloaded successfully!', 'success');
                    hideProgress();
                }, 500);
            } catch (error) {
                console.error('Error:', error);
                hideProgress();
                if (error.message.includes('401') || error.message.includes('authentication')) {
                    showStatus('‚ùå Invalid API key. Please check and try again.', 'error');
                } else {
                    showStatus('‚ùå Error: ' + error.message, 'error');
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = '‚ú® Generate PowerPoint';
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // Progress bar functions
        function showProgress() {
            document.getElementById('progressContainer').style.display = 'block';
            resetProgress();
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        function resetProgress() {
            updateProgress(0, '');
            document.querySelectorAll('.progress-step').forEach(step => {
                step.classList.remove('active', 'completed');
            });
        }

        function updateProgress(percent, stepId) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressBar.style.width = percent + '%';
            progressText.textContent = Math.round(percent) + '%';
            
            if (stepId) {
                // Mark previous steps as completed
                const steps = ['step1', 'step2', 'step3', 'step4'];
                const currentIndex = steps.indexOf(stepId);
                
                steps.forEach((step, index) => {
                    const element = document.getElementById(step);
                    element.classList.remove('active', 'completed');
                    
                    if (index < currentIndex) {
                        element.classList.add('completed');
                    } else if (index === currentIndex) {
                        element.classList.add('active');
                    }
                });
            }
        }

        // Example templates by category
        const exampleTemplates = {
            tech: `The Future of Artificial Intelligence in Healthcare

Artificial intelligence is revolutionizing healthcare by improving diagnostics, personalizing treatment plans, and accelerating drug discovery. Machine learning algorithms can now detect diseases from medical images with accuracy rivaling human experts.

Key applications include early cancer detection through image analysis, predictive analytics for patient outcomes, robotic surgery assistance, and virtual health assistants. AI-powered tools are reducing diagnostic errors and helping doctors make better informed decisions.

The integration of AI with electronic health records enables personalized medicine by analyzing patient data to recommend optimal treatments. Natural language processing helps extract insights from medical literature and patient notes.

Challenges remain including data privacy concerns, the need for regulatory frameworks, potential algorithmic bias, and ensuring AI systems are explainable to healthcare providers. Despite these hurdles, AI promises to make healthcare more accessible and effective for everyone.`,
            
            business: `Digital Transformation Strategy for Modern Enterprises

Digital transformation is no longer optional for businesses seeking to remain competitive in today's fast-paced market. Companies must embrace cloud computing, data analytics, and automation to streamline operations and improve customer experiences.

Key pillars of successful transformation include cloud migration for scalability, data-driven decision making through advanced analytics, customer experience optimization using digital channels, and process automation to reduce costs and errors.

The journey requires strong leadership commitment, clear vision and roadmap, investment in technology infrastructure, and a culture of continuous innovation. Companies must also focus on upskilling employees to work effectively with new technologies.

Success metrics include improved operational efficiency, enhanced customer satisfaction, faster time to market for new products, and increased revenue through digital channels. Regular assessment and adjustment of strategies ensures continued relevance and competitive advantage.`,
            
            education: `Innovative Teaching Methods for the 21st Century Classroom

Modern education must evolve to prepare students for a rapidly changing world. Traditional lecture-based approaches are giving way to interactive, technology-enhanced learning experiences that foster critical thinking and collaboration.

Effective teaching strategies include project-based learning where students solve real-world problems, flipped classroom models that maximize in-class interaction time, gamification to increase engagement and motivation, and personalized learning paths adapted to individual student needs.

Technology integration enhances learning through virtual reality field trips, collaborative online platforms for group projects, adaptive learning software that adjusts to student progress, and digital portfolios showcasing student achievements.

Assessment methods are also evolving beyond traditional tests to include peer evaluation, self-reflection exercises, practical demonstrations of skills, and ongoing formative feedback that guides learning. These approaches better prepare students for future careers and lifelong learning.`,
            
            health: `Mental Health Awareness in the Modern Workplace

Mental health has become a critical concern for organizations worldwide. Creating supportive work environments that prioritize employee wellbeing leads to improved productivity, reduced turnover, and stronger company culture.

Common workplace stressors include high workload and tight deadlines, lack of work-life balance, insufficient recognition and support, unclear expectations and poor communication, and limited opportunities for growth and development.

Effective organizational strategies include flexible work arrangements, mental health resources and counseling services, stress management workshops, open communication channels for concerns, and leadership training on mental health awareness.

Individual practices that support mental health include regular exercise and physical activity, mindfulness and meditation practices, maintaining social connections, setting healthy boundaries, and seeking professional help when needed. Creating a culture where mental health is openly discussed reduces stigma and encourages people to seek support.`,
            
            marketing: `Content Marketing Strategies for 2024

Content marketing continues to evolve as consumer behaviors shift and new platforms emerge. Successful brands focus on creating authentic, valuable content that resonates with their target audience across multiple channels.

Key trends shaping content strategy include short-form video dominance on platforms like TikTok and Instagram Reels, interactive content that engages audiences through quizzes and polls, user-generated content that builds community and trust, and AI-powered personalization for tailored experiences.

Essential components of effective campaigns include consistent brand voice across all channels, data-driven optimization based on performance metrics, multi-platform distribution for maximum reach, and authentic storytelling that connects emotionally with audiences.

Measuring success requires tracking engagement rates and time spent with content, conversion metrics and ROI analysis, audience growth and retention, brand sentiment and awareness, and content performance across different channels. Regular analysis enables continuous improvement and strategic adjustments.`,
            
            environment: `Sustainable Business Practices for a Greener Future

Environmental sustainability has become a business imperative as consumers, investors, and regulators demand responsible corporate behavior. Companies that embrace sustainable practices gain competitive advantages while contributing to global environmental goals.

Key areas for action include reducing carbon footprint through energy efficiency and renewable energy adoption, implementing circular economy principles to minimize waste, sustainable supply chain management with ethical sourcing, and water conservation in operations and products.

Business benefits of sustainability include cost savings through resource efficiency, enhanced brand reputation and customer loyalty, access to green financing and investment, improved risk management and regulatory compliance, and attraction of top talent who value corporate responsibility.

Implementation strategies involve setting measurable sustainability goals with clear timelines, conducting environmental impact assessments, engaging stakeholders in sustainability initiatives, transparent reporting of progress and challenges, and continuous innovation in sustainable products and processes. Leadership commitment and employee engagement are essential for success.`
        };

        function loadExampleByCategory(category) {
            const text = exampleTemplates[category];
            if (text) {
                document.getElementById('ideaInput').value = text;
                showStatus(`üìù ${category.charAt(0).toUpperCase() + category.slice(1)} example loaded into idea generator. Click "Expand Idea" to create full content.`, 'info');
            }
        }

        // Global variable for template file
        let templateFile = null;

        // Generate content from AI prompt with slide count and image generation
        async function generateFromPrompt() {
            const prompt = document.getElementById('ideaInput').value.trim();
            const numSlides = parseInt(document.getElementById('numSlides').value) || 6;
            const generateImages = document.getElementById('generateImages').checked;
            const extractColors = document.getElementById('extractColors').checked;
            const useAsTemplate = document.getElementById('useAsTemplate').checked;
            const apiKey = getApiKey();
            const fileInput = document.getElementById('fileUpload');
            const files = fileInput.files;
            
            if (!apiKey) {
                showStatus('‚ö†Ô∏è Please enter your API key first!', 'error');
                return;
            }
            
            if (!prompt && files.length === 0) {
                showStatus('‚ö†Ô∏è Please enter an idea or attach files!', 'error');
                return;
            }
            
            const promptBtn = document.getElementById('promptBtn');
            promptBtn.disabled = true;
            promptBtn.innerHTML = '<span class="spinner"></span> Expanding idea...';
            
            showStatus('ü§ñ AI is expanding your idea into detailed content...', 'info');
            
            const textInput = document.getElementById('textInput');
            textInput.value = ''; // Clear existing content
            
            try {
                let finalPrompt = prompt;
                let extractedColors = null;
                
                // If files are attached, process them with the prompt
                if (files.length > 0) {
                    const fileContents = [];
                    
                    // Check for PPTX template if checkbox is enabled
                    if (useAsTemplate) {
                        const pptxFiles = Array.from(files).filter(f => f.name.toLowerCase().endsWith('.pptx'));
                        if (pptxFiles.length > 0) {
                            templateFile = pptxFiles[0]; // Use first PPTX as template
                            showStatus(`üìÑ Using ${templateFile.name} as template...`, 'info');
                        } else {
                            showStatus('‚ö†Ô∏è No PPTX file found. Please upload a PowerPoint file to use as template.', 'error');
                            promptBtn.disabled = false;
                            promptBtn.innerHTML = 'üöÄ Expand Idea into Full Content';
                            return;
                        }
                    }
                    
                    // Extract colors if checkbox is enabled
                    if (extractColors) {
                        showStatus('üé® Extracting color theme from files...', 'info');
                        extractedColors = await extractColorsFromFiles(files);
                        if (extractedColors) {
                            showStatus(`‚úÖ Color theme extracted: ${extractedColors.name}`, 'success');
                        }
                    }
                    
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const text = await readFileAsText(file);
                        fileContents.push({
                            filename: file.name,
                            content: text
                        });
                    }
                    
                    // Combine file contents
                    let combinedFiles = '';
                    fileContents.forEach(file => {
                        combinedFiles += `\n\n=== File: ${file.filename} ===\n\n${file.content}`;
                    });
                    
                    // If there's a prompt, use it to guide the processing; otherwise use default
                    finalPrompt = prompt 
                        ? `${prompt}\n\nUse the following file content as the base:\n${combinedFiles}`
                        : `Analyze and convert the following files into a well-structured presentation with ${numSlides} slides:\n${combinedFiles}`;
                }
                
                // Use streaming for Anthropic, non-streaming for others
                if (currentProvider === 'anthropic' && files.length === 0) {
                    // Streaming mode
                    const response = await fetch('/api/generate-content', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            prompt: finalPrompt, 
                            apiKey, 
                            provider: currentProvider,
                            numSlides,
                            generateImages,
                            stream: true
                        })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Content generation failed');
                    }
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let content = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') continue;
                                
                                try {
                                    const parsed = JSON.parse(data);
                                    if (parsed.text) {
                                        content += parsed.text;
                                        textInput.value = content;
                                        // Auto-scroll to show new content
                                        textInput.scrollTop = textInput.scrollHeight;
                                    }
                                } catch (e) {
                                    // Skip invalid JSON
                                }
                            }
                        }
                    }
                } else {
                    // Non-streaming mode for files or non-Anthropic providers
                    const response = await fetch('/api/generate-content', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            prompt: finalPrompt, 
                            apiKey, 
                            provider: currentProvider,
                            numSlides,
                            generateImages,
                            stream: false
                        })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Content generation failed');
                    }
                    
                    const result = await response.json();
                    textInput.value = result.content;
                }
                
                showStatus('‚úÖ Content expanded successfully! Review it below, then click "Preview Slides" to see the design.', 'success');
                
                // Scroll to the text input area
                textInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
            } catch (error) {
                console.error('Error:', error);
                if (error.message.includes('401') || error.message.includes('authentication')) {
                    showStatus('‚ùå Invalid API key. Please check and try again.', 'error');
                } else {
                    showStatus('‚ùå Error: ' + error.message, 'error');
                }
            } finally {
                promptBtn.disabled = false;
                promptBtn.innerHTML = 'üöÄ Expand Idea into Full Content';
            }
        }
        
        // Helper function to read file as text
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }

        // Extract colors from uploaded files
        async function extractColorsFromFiles(files) {
            try {
                // Send files to backend for color extraction
                const formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    formData.append('files', files[i]);
                }
                
                const response = await fetch('/api/extract-colors', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    console.warn('Color extraction failed, using default theme');
                    return null;
                }
                
                const result = await response.json();
                
                if (result.theme) {
                    // Add extracted theme to colorThemes
                    colorThemes['extracted-custom'] = {
                        name: result.theme.name || 'Custom from Files',
                        description: result.theme.description || 'Extracted from your uploaded files',
                        colorPrimary: result.theme.colorPrimary,
                        colorSecondary: result.theme.colorSecondary,
                        colorAccent: result.theme.colorAccent,
                        colorBackground: result.theme.colorBackground || '#FFFFFF',
                        colorText: result.theme.colorText || '#1d1d1d',
                        category: ['custom', 'extracted'],
                        isExtracted: true
                    };
                    
                    // Set this as the selected theme
                    selectedTheme = 'extracted-custom';
                    
                    return colorThemes['extracted-custom'];
                }
                
                return null;
            } catch (error) {
                console.error('Error extracting colors:', error);
                return null;
            }
        }
    </script>
</body>
</html>