<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Permissions-Policy" content="payment=*, camera=(), microphone=(), geolocation=()">
    <title>GENIS.AI Presentation and Document Generator</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="/css/styles.css?v=<?php echo time(); ?>">
    <script async src="https://js.stripe.com/v3/buy-button.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="header-badges-row">
                    <h1 class="brand-name">GENIS.AI</h1>
                    <a href="https://www.producthunt.com/products/genis-ai?embed=true&utm_source=badge-featured&utm_medium=badge&utm_source=badge-genis&#0045;ai" target="_blank" class="product-hunt-badge">
                        <img src="https://api.producthunt.com/widgets/embed-image/v1/featured.svg?post_id=1030870&theme=light&t=1761434413944" alt="Product Hunt" style="height: 26px; width: auto; display: block;" />
                    </a>
                    <a href="https://github.com/skunpoj/pptx" target="_blank" class="github-shield-badge">
                        <img src="https://img.shields.io/github/stars/skunpoj/pptx?style=flat-square&color=24292e&labelColor=24292e&logo=github&logoColor=white&label=Star" alt="GitHub Star" style="height: 24px; width: auto; display: block;" />
                    </a>
                </div>
                <p class="brand-tagline">Transform Your Ideas into Presentations with AI</p>
            </div>
            <div class="header-right">
                <div style="display: flex; flex-direction: column; gap: 0.35rem; align-items: flex-end;">
                    <div class="header-features">
                        <span class="header-feature">ü§ñ AI-Powered</span>
                        <span class="header-feature">üìä Native Charts</span>
                        <span class="header-feature">üé® 8+ Themes</span>
                        <span class="header-feature">üîó Share Links</span>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <div id="userInfo" style="display: none; align-items: center; gap: 0.5rem;">
                            <img id="userAvatar" src="" alt="User" style="width: 24px; height: 24px; border-radius: 50%; border: 2px solid rgba(102, 126, 234, 0.3);">
                            <span id="userName" style="font-weight: 600; color: #667eea; font-size: 0.75rem;"></span>
                            <div id="subscriptionStatus" style="display: none !important; margin-left: 0.5rem;">
                                <span id="subscriptionBadge" style="font-size: 0.75rem; padding: 0.2rem 0.4rem; border-radius: 4px; font-weight: 600;"></span>
                            </div>
                        </div>
                        <a href="/login" class="login-btn" id="authBtn">
                            <span>üîê Login</span>
                        </a>
                        <div class="free-badge">
                            <span class="badge-text">Free 100</span>
                            <span class="badge-icon">üìÑ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="main-grid">
            <!-- Left Panel: Slide Content -->
            <div class="card content-panel">
                <h2>üìù Slide Content</h2>
                
                <!-- Main Content Editor -->
                <div class="content-editor-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <p style="margin: 0; color: #555; font-size: 0.95rem;">Enter or paste your content here, then generate preview</p>
                        <span id="contentCharCount" style="font-size: 0.85rem; color: #888; font-weight: 600;">0 characters / 0 words</span>
                    </div>
                    
                    <textarea id="textInput" class="content-textarea" placeholder="Type or paste your detailed presentation content here...

Example:
Company Overview
- Founded in 2020 with mission to innovate
- Serving 500+ clients globally  
- Revenue growth of 150% year-over-year

Our Products
- AI-powered analytics platform
- Real-time dashboard
- Custom reporting tools" oninput="window.updateCharCount('textInput', 'contentCharCount')"></textarea>
                </div>
                
                <!-- Quick Examples -->
                <div class="quick-examples" style="margin-top: 0.75rem;">
                    <p class="examples-label">üìö Quick Start Examples:</p>
                    <div class="examples-grid">
                        <button class="btn-secondary" onclick="window.loadExampleByCategory('tech')">üíª Tech</button>
                        <button class="btn-secondary" onclick="window.loadExampleByCategory('business')">üíº Business</button>
                        <button class="btn-secondary" onclick="window.loadExampleByCategory('education')">üìö Education</button>
                        <button class="btn-secondary" onclick="window.loadExampleByCategory('health')">üè• Healthcare</button>
                        <button class="btn-secondary" onclick="window.loadExampleByCategory('marketing')">üìà Marketing</button>
                        <button class="btn-secondary" onclick="window.loadExampleByCategory('environment')">üåç Environment</button>
                    </div>
                </div>
                
                <!-- Number of Slides Input and Generate Preview Button Row -->
                <div style="display: flex; gap: 0.75rem; align-items: center; margin-top: 0.75rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; white-space: nowrap;">
                        <label class="option-label" style="margin: 0;">Number of slides:</label>
                        <input type="number" id="numSlides" value="6" min="3" max="20" class="number-input">
                    </div>
                    <button class="btn-primary" onclick="window.generatePreview()" id="previewBtn" style="flex: 1; min-width: 150px;">
                        üëÅÔ∏è Generate Preview
                    </button>
                </div>

                <!-- Slide Count, Warning Button, PromptPay, and Buy Button Row (Logged-in users only) -->
                <div id="paymentButtonsRow" style="display: none; flex; gap: 0.75rem; align-items: center; margin-top: 0.75rem; flex-wrap: wrap;">
                    <!-- Slide Count Display (Logged-in only) -->
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span id="userSlideCount" style="font-size: 0.85rem; color: #667eea; font-weight: 600;"></span>
                    </div>
                    
                    <!-- Subscription Warning Button (Logged-in only) -->
                    <div id="subscriptionWarningBtn" style="display: none;">
                        <button onclick="window.showSubscriptionExplanation()" 
                                style="display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 0.75rem; height: 44px; min-height: 44px; background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: #333; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 1.2rem; text-align: center; border: none; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1); white-space: nowrap;">
                            ‚ö†Ô∏è
                        </button>
                    </div>
                    
                    <!-- Payment Buttons (Logged-in only) -->
                    <div id="promptPayContainer" style="display: none;">
                        <button id="promptPayBtn" onclick="window.createPromptPaySubscription()" 
                                style="display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem 0.75rem; height: 44px; min-height: 44px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; text-decoration: none; border-radius: 6px; font-weight: 600; border: none; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1); white-space: nowrap;">
                            <img src="/icon-thaiqr.png" alt="Thai QR" style="width: 20px; height: 20px; object-fit: contain;">
                        </button>
                    </div>
                    
                    <!-- Credit Card Subscription Button (Logged-in only) -->
                    <div id="creditCardContainer" style="display: none;">
                        <button id="creditCardBtn" onclick="window.createCreditCardSubscription()" 
                                style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.5rem 0.75rem; height: 44px; min-height: 44px; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 0.75rem; text-align: center; border: none; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1); white-space: nowrap;">
                            <span style="font-size: 0.8rem;">üí≥</span>
                            <span>Subscribe</span>
                        </button>
                    </div>
                    
                    <!-- Stripe Buy Button (Logged-in only) -->
                    <div id="stripeButtonContainer" style="display: none;">
                        <stripe-buy-button
                            buy-button-id="buy_btn_1SN5z9GfwbNFFG53MZKQw2qX"
                            publishable-key="pk_live_51OKYdlGfwbNFFG53ez9b6nQ0KuURqAwPV5TJNr4HSTq1MhLpoQoa38iceUvx4vpu5yFxgORYKOzV0Vfsn7GzixlU00ffZcxaVD"
                        >
                        </stripe-buy-button>
                    </div>
                </div>
                
                <!-- Cookie Consent Bar (Non-logged-in users only) -->
                <div id="cookieConsentBtn" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; width: 100%; z-index: 1000; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);">
                    <div style="max-width: 1200px; margin: 0 auto; padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1; min-width: 200px;">
                            <span style="font-size: 1.5rem;">üç™</span>
                            <span style="color: white; font-size: 0.9rem; font-weight: 500;">
                                We use cookies to track your slide usage. By clicking "Accept", you agree to our use of cookies.
                            </span>
                        </div>
                        <button onclick="window.acceptCookies()" 
                                style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 0.9rem; text-align: center; border: 2px solid rgba(255, 255, 255, 0.3); cursor: pointer; transition: all 0.3s ease; white-space: nowrap; flex-shrink: 0;">
                            <span>üç™</span>
                            <span>Accept Cookies</span>
                        </button>
                    </div>
                </div>
                
                <!-- Warning Messages Row -->
                <div style="margin-top: 0.5rem;">
                    <div id="promptPayWarning" style="display: none; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 0.5rem; font-size: 0.8rem; color: #856404;">
                        ‚ö†Ô∏è <strong>Important:</strong> PromptPay is single-use. This is a one-time payment for premium access.
                    </div>
                    <div id="creditCardWarning" style="display: none; background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; padding: 0.5rem; font-size: 0.8rem; color: #0c5460;">
                        ‚úÖ <strong>Credit Card Subscription:</strong> This will auto-renew monthly.
                    </div>
                    <div id="emailMismatchWarning" style="display: none; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 0.3rem 0.5rem; font-size: 0.75rem; color: #856404; max-width: 300px;">
                        ‚ö†Ô∏è <strong>Subscription not found:</strong> You may have subscribed using a different email address.
                    </div>
                </div>
            </div>

            <!-- Right Panel: Preview -->
            <div class="card preview-panel">
                <h2>üëÅÔ∏è Slide Preview</h2>
                
                <!-- Tab Navigation -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 2px solid #ddd; align-items: center; flex-wrap: wrap;">
                    <button class="gallery-tab-btn active" id="slidesTabBtn" onclick="window.showSlidesPreview()">
                        üìÑ Slides
                    </button>
                    <button class="gallery-tab-btn" id="galleryTabBtn" onclick="window.showImageGallery()">
                        üñºÔ∏è Image Gallery
                    </button>
                    <div style="margin-left: auto; display: flex; align-items: center; gap: 0.75rem;">
                        <label id="autoImageGenLabel" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; cursor: pointer; font-size: 0.85rem; white-space: nowrap;">
                            <input type="checkbox" id="autoImageGenCheckbox" checked onchange="window.toggleAutoImageGen()">
                            <span style="color: #667eea; font-weight: 600;">üñºÔ∏è</span>
                        </label>
                        <button class="btn-secondary" id="manualGenerateBtn" onclick="window.generateImagesForSlides()" style="padding: 0.5rem 1rem; font-size: 0.85rem; display: none; white-space: nowrap;">
                            Generate üé®
                        </button>
                    </div>
                </div>
                
                <!-- Slides Preview Container -->
                <div class="preview" id="preview" style="overflow-y: auto !important; flex: 1 1 auto !important; min-height: 0 !important;"></div>
                
                <!-- Image Gallery Container -->
                <div id="imageGalleryContainer" style="display: none; overflow-y: auto !important; flex: 1 1 auto !important; min-height: 0 !important;"></div>
            </div>
        </div>

        <!-- Status Notification -->
        <div id="status"></div>

        <!-- Action Buttons Section -->
        <div id="actionButtonsContainer" style="max-width: none; width: 100%; padding: 0;">
            <!-- Generation Button Section (appears after preview) -->
            <div id="generationSection" style="display: none; margin-bottom: 1rem;">
                <div class="generation-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <!-- Left: Generate PowerPoint Button (stays here always) -->
                    <div class="card" id="generateButtonCard" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 1.5rem; display: flex; flex-direction: column; justify-content: center;">
                        <button class="btn-generate btn-full" onclick="window.generatePresentation()" id="generateBtn" style="background: white; color: #667eea; font-size: 1.2rem; font-weight: 700; padding: 1rem; border: none; border-radius: 8px; cursor: pointer;">
                            ‚ú® Generate PowerPoint Presentation
                        </button>
                        <p style="text-align: center; font-size: 0.85rem; color: white; margin-top: 0.75rem; opacity: 0.95;">
                            Download PPTX, view slides online, auto-convert to PDF, or create shareable link
                        </p>
                    </div>
                    
                    <!-- Right: Results section (appears after generation) -->
                    <div id="generateResultsCard" style="display: none;">
                        <!-- Success message and share link will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Responsive CSS for generation grid -->
        <style>
            @media (max-width: 768px) {
                .generation-grid {
                    grid-template-columns: 1fr !important;
                }
            }
            
            /* Spinner animation for progress indicators */
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>

        <!-- AI IDEA GENERATOR & THEME SELECTOR - Below modify slides section, above settings -->
        <div class="ai-theme-grid protected-disabled" id="aiThemeGrid">
            <!-- Login Overlay -->
            <div class="login-overlay" id="aiThemeOverlay">
                <div class="login-overlay-content">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üîê</div>
                    <h3>Sign In to Unlock Features</h3>
                    <p style="margin-bottom: 1rem;">Unlock AI Idea Generator and Color Themes with a free account</p>
                    <a href="/login" class="login-overlay-btn">Sign In Free</a>
                    <p style="margin-top: 1rem; font-size: 0.85rem; color: #888; margin-bottom: 0;">Get started in seconds ‚Ä¢ No credit card required</p>
                </div>
            </div>
            
            <!-- Left: AI Idea Generator -->
            <div class="card idea-generator-section protected-section" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); border: 3px solid #ff9a56;">
                <h3 style="margin: 0 0 0.5rem 0; color: #d35400; font-size: 1.3rem;">üí° AI Idea Generator</h3>
                <p class="section-description" style="color: #555; margin-bottom: 0.75rem;">Don't have content yet? Let AI expand your simple idea into detailed presentation content</p>
                
                <!-- Idea Input with Character Count -->
                <div style="margin-bottom: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-size: 0.9rem; font-weight: 600; color: #d35400;">Your Idea</span>
                        <span id="ideaCharCount" style="font-size: 0.85rem; color: #888; font-weight: 600;">0 characters / 0 words</span>
                    </div>
                    <textarea id="ideaInput" class="idea-input" placeholder="Describe your presentation idea..." oninput="window.updateCharCount('ideaInput', 'ideaCharCount')">Create a quarterly business review presentation for Q4 2024 showing sales performance, market trends, and strategic initiatives for the executive team.</textarea>
                </div>
                
                <!-- Expand Button -->
                <button class="btn-primary btn-large" onclick="window.generateFromPrompt()" id="promptBtn" style="width: 100%; margin-bottom: 0.75rem;">
                    üöÄ Expand Idea
                </button>
                <p class="helper-text" style="margin-bottom: 0.75rem; margin-top: 0;">This creates detailed text content that you can edit above before generating slides</p>
                
                <!-- File Upload Section (styled like checkboxes) -->
                <div class="checkbox-label checkbox-teal" style="display: block; cursor: default; margin-bottom: 0.5rem;">
                    <strong style="color: #0d9488; display: block; margin-bottom: 0.5rem;">üìé Upload Files (Documents & Images)</strong>
                    <span class="checkbox-desc" style="display: block; margin-bottom: 0.75rem;">Upload PowerPoint templates, documents for content, or images to insert directly into slides</span>
                    <input type="file" id="fileUpload" multiple accept=".txt,.pdf,.doc,.docx,.md,.pptx,.jpg,.jpeg,.png,.gif,.webp,.svg" class="file-input" style="width: 100%; padding: 0.5rem; border: 2px dashed #0d9488; border-radius: 6px; background: #f0fdfa; cursor: pointer; font-size: 0.85rem;">
                    
                    <!-- File List -->
                    <div id="fileList" class="file-list-container" style="margin-top: 0.75rem;"></div>
                </div>
                
                <!-- Options Checkboxes -->
                <div class="options-container">
                    <!-- Combined Image Options + Number of Images Row -->
                    <div class="checkbox-label checkbox-purple" style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: start;">
                        <label style="display: flex; align-items: start; gap: 0.75rem; cursor: pointer; flex: 1;">
                            <input type="checkbox" id="generateImages" checked style="margin-top: 0.25rem; flex-shrink: 0;">
                            <span>
                                <strong>üñºÔ∏è AI Image Generation & Insertion</strong>
                                <span class="checkbox-desc">Generate AI image suggestions from content descriptions AND insert uploaded images directly into appropriate slides based on context</span>
                            </span>
                        </label>
                        <div style="display: flex; align-items: center; gap: 0.5rem; white-space: nowrap;">
                            <label style="font-weight: 600; color: #555; font-size: 0.9rem;">Images to generate:</label>
                            <input type="number" id="numImagesToGenerate" value="3" min="0" max="20" class="number-input" style="width: 70px;">
                        </div>
                    </div>
                    
                    <!-- Extract Colors Checkbox -->
                    <label class="checkbox-label checkbox-blue">
                        <input type="checkbox" id="extractColors" checked>
                        <span>
                            <strong>üé® Extract & auto-select color theme from uploaded files</strong>
                            <span class="checkbox-desc">File content will be incorporated and used together with your idea prompt. AI analyzes uploaded files to suggest and automatically select color themes based on file names/types (e.g., finance ‚Üí blue, healthcare ‚Üí teal)</span>
                        </span>
                    </label>
                    
                    <!-- Use as Template Checkbox -->
                    <label class="checkbox-label checkbox-orange">
                        <input type="checkbox" id="useAsTemplate" checked>
                        <span>
                            <strong>üìÑ Use uploaded PPTX as template/base</strong>
                            <span class="checkbox-desc">Uses uploaded PowerPoint file as template - preserves formatting, modifies content, or adds new slides</span>
                        </span>
                    </label>
                </div>
            </div>

            <!-- Right: Color Theme & Output Format -->
            <div class="card protected-section" id="themeSelector" style="background: #f0fff4; border: 2px solid #82C341;">
                <div class="theme-header">
                    <h3>üé® Choose Color Theme</h3>
                    <span id="suggestedBadge" class="suggested-badge" style="display: none;">AI Suggested</span>
                </div>
                <p class="theme-description">Select a color palette for your presentation (AI may suggest one based on your content)</p>
                <div id="themeGrid" class="theme-grid"></div>
                
                <!-- Output File Type Selection -->
                <label style="display: block; font-weight: 700; color: #2d8659; margin: 1.5rem 0 0.5rem 0;">üìÑ Output File Type:</label>
                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: background 0.2s;" class="file-type-option">
                            <input type="radio" name="outputType" value="pptx-direct" checked onchange="window.selectOutputType('pptx-direct')" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 600; color: #333; font-size: 0.85rem;">üìä PPTX Direct</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: background 0.2s;" class="file-type-option">
                            <input type="radio" name="outputType" value="pptx-skill" onchange="window.selectOutputType('pptx-skill')" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 600; color: #333; font-size: 0.85rem;">üìä PPTX Skill</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: background 0.2s;" class="file-type-option">
                            <input type="radio" name="outputType" value="docx" onchange="window.selectOutputType('docx')" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 600; color: #333; font-size: 0.85rem;">üìù Word</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: background 0.2s;" class="file-type-option">
                            <input type="radio" name="outputType" value="pdf" onchange="window.selectOutputType('pdf')" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 600; color: #333; font-size: 0.85rem;">üìÑ PDF</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; border-radius: 6px; transition: background 0.2s;" class="file-type-option">
                            <input type="radio" name="outputType" value="xlsx" onchange="window.selectOutputType('xlsx')" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 600; color: #333; font-size: 0.85rem;">üìà Excel</span>
                        </label>
                    </div>
                <p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; color: #666;">Select the output format for your generated document</p>
            </div>
        </div>

        <!-- Settings Card -->
        <div class="card settings-card">
            <h2 onclick="window.toggleSettingsSection()" class="collapsible-header">
                <span>‚öôÔ∏è Advanced Configuration</span>
                <span id="settingsToggleIcon" class="toggle-icon">‚ñº</span>
            </h2>
            
            <div id="settingsSectionContainer" style="display: block;">
                <div class="settings-tabs">
                    <button class="settings-tab active" onclick="window.switchSettingsTab('api')" id="tab-api">
                        üîë API Keys
                    </button>
                    <button class="settings-tab" onclick="window.switchSettingsTab('prompts')" id="tab-prompts">
                        üìù AI Prompts
                    </button>
                </div>
                
                <!-- API Settings Content -->
                <div id="apiSettingsContent">
                    <h3 style="margin-top: 1rem;">üîë API Configuration</h3>
                
                    <!-- API Keys Grid - Left/Right Panel Layout -->
                    <div class="api-keys-grid">
                        <!-- Left Panel: Content Generation Provider -->
                        <div class="card api-keys-left-panel">
                            <h3 style="margin-top: 0; font-size: 1.1rem; color: #667eea;">üìù Content Generation</h3>
                            
                            <!-- Provider Selection for Content Generation -->
                            <div class="provider-selection">
                                <h3 style="font-size: 1rem;">AI Provider Selection</h3>
                                <p style="font-size: 0.85rem; color: #666; margin-bottom: 0.75rem;">Select which AI to use for writing presentation content and slide structure</p>
                                <div class="provider-buttons">
                                    <button class="provider-btn active" onclick="window.selectProvider('bedrock')" id="provider-bedrock">Bedrock</button>
                                    <button class="provider-btn" onclick="window.selectProvider('anthropic')" id="provider-anthropic">Anthropic</button>
                                    <button class="provider-btn" onclick="window.selectProvider('openai')" id="provider-openai">OpenAI</button>
                                    <button class="provider-btn" onclick="window.selectProvider('gemini')" id="provider-gemini">Gemini</button>
                                    <button class="provider-btn" onclick="window.selectProvider('openrouter')" id="provider-openrouter">OpenRouter</button>
                                </div>
                            </div>
                            
                            <!-- Content Generation API Key Forms -->
                            <div id="contentGenApiKeys" style="margin-top: 1rem;">
                                <!-- Anthropic Section -->
                                <div class="api-section provider-section" id="section-anthropic">
                                    <h3>Anthropic Claude API</h3>
                                    <div class="info-box">
                                        <strong>To get your API key:</strong>
                                        <ol>
                                            <li>Go to <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a></li>
                                            <li>Sign up or log in</li>
                                            <li>Navigate to "API Keys"</li>
                                            <li>Create and copy your key</li>
                                        </ol>
                                    </div>
                                    <form autocomplete="off" onsubmit="return false;">
                                        <div class="input-group">
                                            <input type="text" 
                                                   id="apiKey-anthropic" 
                                                   placeholder="sk-ant-api03-..."
                                                   autocomplete="off"
                                                   data-form-type="other"
                                                   data-lpignore="true"
                                                   name="not-a-password"
                                                   spellcheck="false"
                                                   style="font-family: monospace; letter-spacing: 0.5px;">
                                            <button class="btn-primary" onclick="window.saveApiKey('anthropic'); return false;" type="button">Save Key</button>
                                        </div>
                                    </form>
                                </div>

                                <!-- OpenAI Section -->
                                <div class="api-section provider-section" id="section-openai" style="display: none;">
                                    <h3>OpenAI API</h3>
                                    <div class="info-box">
                                        <strong>To get your API key:</strong>
                                        <ol>
                                            <li>Go to <a href="https://platform.openai.com/" target="_blank">platform.openai.com</a></li>
                                            <li>Sign up or log in</li>
                                            <li>Navigate to "API Keys"</li>
                                            <li>Create and copy your key</li>
                                        </ol>
                                    </div>
                                    <form autocomplete="off" onsubmit="return false;">
                                        <div class="input-group">
                                            <input type="text" 
                                                   id="apiKey-openai" 
                                                   placeholder="sk-..."
                                                   autocomplete="off"
                                                   data-form-type="other"
                                                   data-lpignore="true"
                                                   name="not-a-password"
                                                   spellcheck="false"
                                                   style="font-family: monospace; letter-spacing: 0.5px;">
                                            <button class="btn-primary" onclick="window.saveApiKey('openai'); return false;" type="button">Save Key</button>
                                        </div>
                                    </form>
                                </div>

                                <!-- Gemini Section -->
                                <div class="api-section provider-section" id="section-gemini" style="display: none;">
                                    <h3>Google Gemini API</h3>
                                    <div class="info-box">
                                        <strong>To get your API key:</strong>
                                        <ol>
                                            <li>Go to <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a></li>
                                            <li>Sign up or log in</li>
                                            <li>Click "Create API Key"</li>
                                            <li>Copy your key</li>
                                        </ol>
                                    </div>
                                    <form autocomplete="off" onsubmit="return false;">
                                        <div class="input-group">
                                            <input type="text" 
                                                   id="apiKey-gemini" 
                                                   placeholder="AIza..."
                                                   autocomplete="off"
                                                   data-form-type="other"
                                                   data-lpignore="true"
                                                   name="not-a-password"
                                                   spellcheck="false"
                                                   style="font-family: monospace; letter-spacing: 0.5px;">
                                            <button class="btn-primary" onclick="window.saveApiKey('gemini'); return false;" type="button">Save Key</button>
                                        </div>
                                    </form>
                                </div>

                                <!-- OpenRouter Section -->
                                <div class="api-section provider-section" id="section-openrouter" style="display: none;">
                                    <h3>OpenRouter API</h3>
                                    <div class="info-box">
                                        <strong>To get your API key:</strong>
                                        <ol>
                                            <li>Go to <a href="https://openrouter.ai/" target="_blank">openrouter.ai</a></li>
                                            <li>Sign up or log in</li>
                                            <li>Navigate to "Keys"</li>
                                            <li>Create and copy your key</li>
                                        </ol>
                                    </div>
                                    <form autocomplete="off" onsubmit="return false;">
                                        <div class="input-group">
                                            <input type="text" 
                                                   id="apiKey-openrouter" 
                                                   placeholder="sk-or-..."
                                                   autocomplete="off"
                                                   data-form-type="other"
                                                   data-lpignore="true"
                                                   name="not-a-password"
                                                   spellcheck="false"
                                                   style="font-family: monospace; letter-spacing: 0.5px;">
                                            <button class="btn-primary" onclick="window.saveApiKey('openrouter'); return false;" type="button">Save Key</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Panel: Image Generation Provider -->
                        <div class="card api-keys-right-panel">
                            <h3 style="margin-top: 0; font-size: 1.1rem; color: #ff9800;">üé® Image Generation</h3>
                            
                            <!-- Provider Selection for Image Generation -->
                            <div class="provider-selection">
                                <h3 style="font-size: 1rem;">AI Provider Selection</h3>
                                <p style="font-size: 0.85rem; color: #666; margin-bottom: 0.75rem;">Select which AI to use for creating actual images from descriptions (optional)</p>
                                <div class="provider-buttons">
                                    <button class="provider-btn-img active" onclick="window.selectImageProvider('huggingface')" id="img-provider-huggingface">
                                        ü§ó Hugging Face
                                        <span style="display: block; font-size: 0.7rem; opacity: 0.8;">Free API ‚Ä¢ Default</span>
                                    </button>
                                    <button class="provider-btn-img" onclick="window.selectImageProvider('dalle')" id="img-provider-dalle">DALL-E 3</button>
                                    <button class="provider-btn-img" onclick="window.selectImageProvider('stability')" id="img-provider-stability">Stability AI</button>
                                    <button class="provider-btn-img" onclick="window.selectImageProvider('gemini')" id="img-provider-gemini" disabled style="opacity: 0.5; cursor: not-allowed; position: relative;">
                                        Gemini Imagen
                                        <span style="display: block; font-size: 0.65rem; color: #e74c3c; font-weight: 700;">‚ö†Ô∏è Not Available</span>
                                    </button>
                                </div>
                                <p style="font-size: 0.75rem; color: #2ecc71; margin-top: 0.5rem; font-weight: 600;">üéÅ Hugging Face: FREE API access to Stable Diffusion & FLUX models!</p>
                                <p style="font-size: 0.75rem; color: #888; margin-top: 0.25rem; font-style: italic;">üí° Get free API key at <a href="https://huggingface.co/settings/tokens" target="_blank" style="color: #667eea;">huggingface.co/settings/tokens</a></p>
                            </div>
                            
                            <!-- Image Generation API Key Forms -->
                            <div id="imageGenApiKeys" style="margin-top: 1rem;">
                                <!-- Hugging Face Section (for image generation) - SHOWN BY DEFAULT & FIRST -->
                                <div class="api-section provider-section" id="section-huggingface">
                                    <h3>ü§ó Hugging Face API</h3>
                                    <div class="info-box" style="background: linear-gradient(135deg, #fff8e1 0%, #ffe0b2 100%); border-left: 4px solid #ff9800;">
                                        <strong style="color: #e65100;">üéÅ FREE Image Generation!</strong>
                                        <p style="margin-top: 0.5rem; color: #666;">Hugging Face offers <strong>FREE API access</strong> to powerful models like Stable Diffusion XL and FLUX.1</p>
                                        <strong style="margin-top: 1rem; display: block;">To get your FREE API key:</strong>
                                        <ol>
                                            <li>Go to <a href="https://huggingface.co/join" target="_blank">huggingface.co/join</a> (create account)</li>
                                            <li>Navigate to <a href="https://huggingface.co/settings/tokens" target="_blank">Settings ‚Üí Access Tokens</a></li>
                                            <li>Click "New token" or "Create new token"</li>
                                            <li>Give it a name (e.g., "GENIS.AI") and select "Read" access</li>
                                            <li>Copy your token (starts with <code>hf_...</code>)</li>
                                        </ol>
                                        <p style="margin-top: 0.5rem; color: #666;">üí° <strong>Note:</strong> Hugging Face is the default and recommended option for FREE unlimited image generation!</p>
                                    </div>
                                    <form autocomplete="off" onsubmit="return false;">
                                        <div class="input-group">
                                            <input type="text" 
                                                   id="apiKey-huggingface" 
                                                   placeholder="hf_..."
                                                   autocomplete="off"
                                                   data-form-type="other"
                                                   data-lpignore="true"
                                                   name="not-a-password"
                                                   spellcheck="false"
                                                   style="font-family: monospace; letter-spacing: 0.5px;">
                                            <button class="btn-primary" onclick="window.saveApiKey('huggingface'); return false;" type="button">Save Key</button>
                                        </div>
                                    </form>
                                </div>
                                
                                <!-- DALL-E Section (for image generation) - HIDDEN BY DEFAULT -->
                                <div class="api-section provider-section" id="section-dalle" style="display: none;">
                                    <h3>DALL-E 3 API (OpenAI)</h3>
                                    <div class="info-box">
                                        <strong>To get your API key:</strong>
                                        <ol>
                                            <li>Go to <a href="https://platform.openai.com/" target="_blank">platform.openai.com</a></li>
                                            <li>Sign up or log in</li>
                                            <li>Navigate to "API Keys"</li>
                                            <li>Create and copy your key</li>
                                        </ol>
                                        <p style="margin-top: 0.5rem; color: #666;">üí° <strong>Note:</strong> DALL-E 3 uses the same API key as OpenAI's text models. If you've already entered an OpenAI key above, it will be used automatically.</p>
                                    </div>
                                    <form autocomplete="off" onsubmit="return false;">
                                        <div class="input-group">
                                            <input type="text" 
                                                   id="apiKey-dalle" 
                                                   placeholder="sk-... (same as OpenAI)"
                                                   autocomplete="off"
                                                   data-form-type="other"
                                                   data-lpignore="true"
                                                   name="not-a-password"
                                                   spellcheck="false"
                                                   style="font-family: monospace; letter-spacing: 0.5px;">
                                            <button class="btn-primary" onclick="window.saveApiKey('dalle'); return false;" type="button">Save Key</button>
                                        </div>
                                    </form>
                                </div>
                                
                                <!-- Stability AI Section (for image generation) - HIDDEN BY DEFAULT -->
                                <div class="api-section provider-section" id="section-stability" style="display: none;">
                                    <h3>Stability AI API</h3>
                                    <div class="info-box">
                                        <strong>To get your API key:</strong>
                                        <ol>
                                            <li>Go to <a href="https://platform.stability.ai/" target="_blank">platform.stability.ai</a></li>
                                            <li>Sign up or log in</li>
                                            <li>Navigate to "API Keys"</li>
                                            <li>Create and copy your key</li>
                                        </ol>
                                        <p style="margin-top: 0.5rem; color: #666;">üí° <strong>Note:</strong> This key is only needed if you want to use Stability AI for image generation. It's separate from content generation.</p>
                                    </div>
                                    <form autocomplete="off" onsubmit="return false;">
                                        <div class="input-group">
                                            <input type="text" 
                                                   id="apiKey-stability" 
                                                   placeholder="sk-..."
                                                   autocomplete="off"
                                                   data-form-type="other"
                                                   data-lpignore="true"
                                                   name="not-a-password"
                                                   spellcheck="false"
                                                   style="font-family: monospace; letter-spacing: 0.5px;">
                                            <button class="btn-primary" onclick="window.saveApiKey('stability'); return false;" type="button">Save Key</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- AI Prompts Editor Tab -->
                <div id="promptsSettingsContent" style="display: none;">
                    <h3 style="margin-top: 1rem;">üìù AI Prompt Customization</h3>
                    <p class="prompts-description">Customize the AI prompts used for content generation, slide design, and file processing. All prompts are automatically backed up before changes.</p>
                    
                    <div id="promptEditorContainer">
                        <div class="prompts-cta">
                            <p style="text-align: center; color: #666;">Loading prompts...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer - Features & Guide Section -->
        <div class="footer">
            <div class="footer-content">
                <!-- Security Banner -->
                <div class="footer-security-banner">
                    <span class="security-icon">üîí</span>
                    <p>All processing on your server ‚Ä¢ Your API key stays local & secure</p>
    </div>

                <!-- Features Grid -->
                <div class="footer-section">
                    <h3 class="footer-section-title">‚ú® Powerful Features</h3>
                    
                    <!-- Vibrant Description -->
                    <div class="footer-description">
                        <p>
                            <strong>GENIS.AI</strong> is your ultimate AI-powered presentation creation platform that transforms ideas into stunning, professional presentations in seconds! 
                            Harness the power of cutting-edge AI models like Claude, GPT-5, Gemini, or our <strong>FREE Amazon Bedrock</strong> to generate beautiful slides with native charts, 
                            professional themes, live previews, and smart designs. Edit online, share instantly with unique links, auto-convert to PDF, and customize every detail‚Äîall while 
                            keeping your data secure on your own server. Whether you're crafting business pitches, educational content, or marketing presentations, GENIS.AI makes it effortless. 
                            <a href="https://aboutus.genis.ai" target="_blank" rel="noopener noreferrer" class="footer-link">Learn more about us ‚Üí</a>
                    </p>
                </div>
                
                    <div class="footer-features-grid">
                        <div class="footer-feature-card">
                            <div class="feature-icon">ü§ñ</div>
                            <strong>AI-Powered</strong>
                            <span>Claude, GPT-4, Gemini, or FREE Bedrock</span>
                    </div>
                        <div class="footer-feature-card">
                            <div class="feature-icon">üìä</div>
                            <strong>Native Charts</strong>
                            <span>Bar, Pie, Line, Area - fully editable</span>
                    </div>
                        <div class="footer-feature-card">
                            <div class="feature-icon">üé®</div>
                            <strong>8+ Themes</strong>
                            <span>Professional color schemes</span>
                    </div>
                        <div class="footer-feature-card">
                            <div class="feature-icon">üìÑ</div>
                            <strong>Auto PDF</strong>
                            <span>PPTX + PDF generated together</span>
                    </div>
                        <div class="footer-feature-card">
                            <div class="feature-icon">üîó</div>
                            <strong>Share Links</strong>
                            <span>One link, unlimited views</span>
                    </div>
                        <div class="footer-feature-card">
                            <div class="feature-icon">‚úèÔ∏è</div>
                            <strong>Edit Online</strong>
                            <span>Modify slides in browser</span>
                    </div>
                        <div class="footer-feature-card">
                            <div class="feature-icon">üëÅÔ∏è</div>
                            <strong>Live Preview</strong>
                            <span>See before you download</span>
                    </div>
                        <div class="footer-feature-card">
                            <div class="feature-icon">üéØ</div>
                            <strong>Smart Design</strong>
                            <span>Decorative shapes & graphics</span>
                        </div>
                    </div>
                </div>
                
                <!-- API Options -->
                <div class="footer-section">
                    <h3 class="footer-section-title">üîë Flexible API Options</h3>
                    <div class="footer-api-grid">
                        <div class="footer-api-card footer-api-featured">
                            <div class="api-badge featured">üíé Option 1</div>
                            <h4>Use Our FREE Amazon Bedrock!</h4>
                            <p>Don't have an API key? No problem! We provide <strong>FREE unlimited access</strong> to Amazon Bedrock (Claude 3.5 Sonnet) - no credit card, no sign up, no catch!</p>
                        </div>
                        <div class="footer-api-card">
                            <div class="api-badge">Option 2</div>
                            <h4>Bring Your Own Key (BYOK)</h4>
                            <p>Use your own Anthropic, OpenAI, Google Gemini, or OpenRouter API key. You control costs and usage.</p>
                    </div>
                    </div>
                </div>
                
                <!-- Quick Start Guide -->
                <div class="footer-section">
                    <h3 class="footer-section-title">üéØ Quick Start Guide</h3>
                    <div class="footer-steps-grid">
                        <div class="step-card">
                            <div class="step-number">1</div>
                            <p>Enter your API key (or skip to use FREE Bedrock)</p>
                </div>
                        <div class="step-card">
                            <div class="step-number">2</div>
                            <p>Type your content or use AI Idea Generator</p>
                </div>
                        <div class="step-card">
                            <div class="step-number">3</div>
                            <p>Click "Generate Preview" to see slides</p>
            </div>
                        <div class="step-card">
                            <div class="step-number">4</div>
                            <p>Modify slides if needed with AI assistance</p>
                        </div>
                        <div class="step-card">
                            <div class="step-number">5</div>
                            <p>Click "Generate PowerPoint" to download</p>
                        </div>
                        <div class="step-card">
                            <div class="step-number">6</div>
                            <p>View online, share links, or download PDF!</p>
                        </div>
        </div>
    </div>
            </div>
        </div>
    </div>


    <!-- Load JavaScript Modules -->
    <!-- Core modules first -->
    <script src="/js/themes.js"></script>
    <script src="/js/charts.js"></script>
    <script src="/js/ui.js"></script>
    <script src="/js/preview.js"></script>
    <script src="/js/imageGallery.js"></script>
    
    <!-- API modules BEFORE api.js (important for function exports) -->
    <!-- Using fresh file name to avoid caching issues -->
    <script src="/js/api/capabilities.js"></script>
    <script src="/js/api/slidePreview.js"></script>
    <script src="/js/api/generation.js"></script>
    <script src="/js/api/viewer.js"></script>
    <script src="/js/api/sharing.js"></script>
    <script src="/js/api/modification.js"></script>
    
    <!-- App and utilities -->
    <script src="/js/app.js"></script>
    <script src="/js/fileHandler.js"></script>
    <script src="/js/skills.js"></script>
    <script src="/js/promptEditor.js"></script>
    
    <!-- API.js LAST (it checks if functions are loaded) -->
    <script src="/js/api.js"></script>
    
    <!-- Integration Diagnostics Script -->
    <script>
        // Consolidated page load handler
        window.addEventListener('load', async function() {
            // Update character counts for textareas with initial content
            if (window.updateCharCount) {
                window.updateCharCount('textInput', 'contentCharCount');
                window.updateCharCount('ideaInput', 'ideaCharCount');
            }
        
            // Run diagnostics
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîç GENIS.AI - INTEGRATION DIAGNOSTICS');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('');
            
            let allPassed = true;
            
            // Check all required functions
            const requiredFunctions = {
                'window.showStatus': window.showStatus,
                'window.generatePreview': window.generatePreview,
                'window.generateFromPrompt': window.generateFromPrompt,
                'window.generatePresentation': window.generatePresentation,
                'window.displayPreview': window.displayPreview,
                'window.getApiKey': window.getApiKey,
                'window.modifySlides': window.modifySlides,
                'window.loadExampleByCategory': window.loadExampleByCategory,
                'window.selectProvider': window.selectProvider,
                'window.saveApiKey': window.saveApiKey,
                'window.displayThemeSelector': window.displayThemeSelector,
                'window.selectTheme': window.selectTheme
            };
            
            console.log('üìã FUNCTION EXPORTS CHECK:');
            console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
            for (const [name, func] of Object.entries(requiredFunctions)) {
                const exists = typeof func === 'function';
                const status = exists ? '‚úÖ' : '‚ùå';
                console.log(`${status} ${name}: ${typeof func}`);
                if (!exists) allPassed = false;
            }
            console.log('');
            
            // Check colorThemes
            console.log('üé® THEMES CHECK:');
            console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
            if (window.colorThemes && typeof window.colorThemes === 'object') {
                const themeCount = Object.keys(window.colorThemes).length;
                console.log(`‚úÖ window.colorThemes: ${themeCount} themes loaded`);
                console.log('   Themes:', Object.keys(window.colorThemes).join(', '));
            } else {
                console.log('‚ùå window.colorThemes: NOT LOADED');
                allPassed = false;
            }
            console.log('');
            
            // Check DOM elements
            console.log('üìÑ DOM ELEMENTS CHECK:');
            console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
            const requiredElements = [
                'textInput', 'ideaInput', 'previewBtn', 'promptBtn',
                'preview', 'status', 'themeSelector', 'numSlides',
                'generateImages', 'extractColors', 'useAsTemplate', 'fileUpload'
            ];
            
            for (const id of requiredElements) {
                const element = document.getElementById(id);
                const status = element ? '‚úÖ' : '‚ùå';
                console.log(`${status} #${id}: ${element ? element.tagName : 'NOT FOUND'}`);
                if (!element) allPassed = false;
            }
            console.log('');
            
            // Check current provider
            console.log('‚öôÔ∏è  CONFIGURATION:');
            console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
            console.log(`   Current Provider: ${window.currentProvider || 'NOT SET'}`);
            console.log(`   Current View: ${window.currentView || 'NOT SET'}`);
            console.log('');
            
            // Final summary
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            if (allPassed) {
                console.log('‚úÖ ALL CHECKS PASSED - Integration OK!');
                console.log('');
                console.log('üéØ Next steps:');
                console.log('   1. Set your API key in Advanced Configuration');
                console.log('   2. Try clicking "Generate Preview" button');
                console.log('   3. Try clicking "Expand Idea" button');
            } else {
                console.log('‚ùå SOME CHECKS FAILED - See errors above');
                console.log('');
                console.log('üîß Troubleshooting:');
                console.log('   1. Hard refresh: Ctrl+Shift+F5');
                console.log('   2. Clear cache and reload');
                console.log('   3. Check browser console for errors');
            }
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('');
            
            // Add visual indicator to page
            if (allPassed) {
                console.log('üí° TIP: All systems operational! You can now use the app.');
            } else {
                console.log('‚ö†Ô∏è  WARNING: Some systems not loaded properly!');
            }
            
            // Check for payment status first
            checkPaymentStatus();
            
            // Function to update UI based on auth state (define before using)
            const updateAuthUI = (data) => {
                const authBtn = document.getElementById('authBtn');
                const userInfo = document.getElementById('userInfo');
                const userAvatar = document.getElementById('userAvatar');
                const userName = document.getElementById('userName');
                const aiThemeGrid = document.getElementById('aiThemeGrid');
                const themeSelector = document.getElementById('themeSelector');
                const aiThemeOverlay = document.getElementById('aiThemeOverlay');
                
                if (data.authenticated && data.user) {
                    // User is authenticated - update UI
                    console.log('‚úÖ Updating UI for authenticated user');
                    
                    // Update login button
                    if (authBtn) {
                        authBtn.href = '/logout';
                        const span = authBtn.querySelector('span');
                        if (span) {
                            span.textContent = 'üîì Logout';
                            console.log('‚úÖ Button set to Logout');
                        }
                    }
                    
                    // Update user info
                    if (data.user.picture && userAvatar) {
                        userAvatar.src = data.user.picture;
                        userAvatar.style.display = 'block';
                        userAvatar.style.visibility = 'visible';
                    }
                    if ((data.user.name || data.user.email) && userName) {
                        userName.textContent = data.user.name || data.user.email;
                        userName.style.display = 'block';
                        userName.style.visibility = 'visible';
                    }
                    if (userInfo) {
                        userInfo.style.display = 'flex';
                        userInfo.style.visibility = 'visible';
                        console.log('‚úÖ User info displayed');
                    }
                    
                    // Unlock protected sections
                    if (aiThemeGrid) {
                        aiThemeGrid.classList.remove('protected-disabled');
                        console.log('‚úÖ AI Theme Grid unlocked');
                    }
                    if (themeSelector) {
                        themeSelector.classList.remove('protected-disabled');
                        const themeOverlay = themeSelector.querySelector('.login-overlay');
                        if (themeOverlay) {
                            themeOverlay.style.display = 'none';
                        }
                        console.log('‚úÖ Theme Selector unlocked');
                    }
                    if (aiThemeOverlay) {
                        aiThemeOverlay.style.display = 'none';
                    }
                    
                    // Show payment buttons
                    const paymentButtonsRow = document.getElementById('paymentButtonsRow');
                    if (paymentButtonsRow) {
                        paymentButtonsRow.style.display = 'flex';
                    }
                    
                    return true; // Successfully authenticated
                } else {
                    // User not authenticated
                    console.log('‚ùå Updating UI for non-authenticated user');
                    if (authBtn) {
                        authBtn.href = '/login';
                        const span = authBtn.querySelector('span');
                        if (span) span.textContent = 'üîê Login';
                    }
                    if (userInfo) {
                        userInfo.style.display = 'none';
                        userInfo.style.visibility = 'hidden';
                    }
                    if (aiThemeGrid) {
                        aiThemeGrid.classList.add('protected-disabled');
                    }
                    if (themeSelector) {
                        themeSelector.classList.add('protected-disabled');
                    }
                    if (aiThemeOverlay) {
                        aiThemeOverlay.style.display = 'block';
                    }
                    
                    return false; // Not authenticated
                }
            };
            
            // Check authentication and subscription status
            // First check if we're returning from auth callback
            const urlParams = new URLSearchParams(window.location.search);
            const authCallback = urlParams.get('auth') === 'callback';
            const hasCode = urlParams.has('code') || window.location.pathname === '/callback';
            
            if (authCallback || hasCode) {
                console.log('üîÑ Detected auth callback, waiting for session...');
                console.log('   URL:', window.location.href);
                // Clean up URL after a delay to ensure session is set
                setTimeout(() => {
                    if (urlParams.get('auth') === 'callback' || urlParams.has('code')) {
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                }, 100);
            }
            
            // Check authentication with retry logic
            const checkAuthWithRetry = async (retries = 3, delay = 500) => {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch('/api/user', {
                            method: 'GET',
                            credentials: 'include', // Important: include cookies
                            cache: 'no-cache'
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        console.log(`üîç Auth check attempt ${i + 1}/${retries}:`, data);
                        
                        // If authenticated, return immediately
                        if (data.authenticated && data.user) {
                            console.log('‚úÖ Authentication confirmed');
                            return data;
                        }
                        
                        // If not authenticated and this isn't the last retry, wait and retry
                        if (i < retries - 1) {
                            console.log(`‚è≥ Not authenticated yet, retrying in ${delay}ms...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 1.5; // Exponential backoff
                        } else {
                            // Last retry failed
                            return data;
                        }
                    } catch (error) {
                        console.error(`‚ùå Auth check error (attempt ${i + 1}):`, error);
                        if (i < retries - 1) {
                            await new Promise(resolve => setTimeout(resolve, delay));
                        } else {
                            throw error;
                        }
                    }
                }
            };
            
            try {
                const data = (authCallback || hasCode)
                    ? await checkAuthWithRetry(8, 500) // More retries after callback with longer delay
                    : await checkAuthWithRetry(1, 0);  // Single check on normal load
                
                console.log('üîç Final auth response:', data);
                console.log('   authenticated:', data.authenticated);
                console.log('   has user:', !!data.user);
                console.log('   user data:', data.user);
                
                // Also log cookies for debugging
                console.log('üç™ Cookies:', document.cookie);
                
                const authBtn = document.getElementById('authBtn');
                const userInfo = document.getElementById('userInfo');
                const userAvatar = document.getElementById('userAvatar');
                const userName = document.getElementById('userName');
                const aiThemeGrid = document.getElementById('aiThemeGrid');
                const themeSelector = document.getElementById('themeSelector');
                
                if (data.authenticated && data.user) {
                    // User is logged in - use the updateAuthUI function
                    console.log('‚úÖ User authenticated, updating UI...');
                    console.log('   User data:', { name: data.user.name, email: data.user.email, hasPicture: !!data.user.picture });
                    
                    // Show slide count
                    if (data.user.slideCount !== undefined) {
                        const userSlideCount = document.getElementById('userSlideCount');
                        if (userSlideCount) {
                            userSlideCount.textContent = `Total slides: ${data.user.slideCount}`;
                            userSlideCount.style.display = 'inline';
                        }
                    }
                    
                    // Update UI using shared function
                    updateAuthUI(data);
                    
                    // Check subscription status (will hide payment buttons if user has active subscription)
                    checkSubscriptionStatus();
                    
                } else {
                    // User is not logged in
                    console.log('‚ùå User not authenticated');
                    console.log('   Auth data:', data);
                    
                    // Update logout button to login
                    if (authBtn) {
                        authBtn.href = '/login';
                        const authBtnSpan = authBtn.querySelector('span');
                        if (authBtnSpan) {
                            authBtnSpan.textContent = 'üîê Login';
                            console.log('‚úÖ Logout button updated to Login');
                        } else {
                            console.error('‚ùå Login button span not found!');
                        }
                    } else {
                        console.error('‚ùå authBtn element not found!');
                    }
                    userInfo.style.display = 'none';
                    userInfo.style.visibility = 'hidden';
                    userAvatar.style.display = 'none';
                    userName.style.display = 'none';
                    
                    // HIDE payment buttons row for non-logged-in users
                    const paymentButtonsRow = document.getElementById('paymentButtonsRow');
                    if (paymentButtonsRow) {
                        paymentButtonsRow.style.display = 'none';
                    }
                    
                    // Hide all payment-related elements
                    const subscriptionWarningBtn = document.getElementById('subscriptionWarningBtn');
                    const promptPayContainer = document.getElementById('promptPayContainer');
                    const creditCardContainer = document.getElementById('creditCardContainer');
                    const stripeButtonContainer = document.getElementById('stripeButtonContainer');
                    const emailMismatchWarning = document.getElementById('emailMismatchWarning');
                    
                    if (subscriptionWarningBtn) subscriptionWarningBtn.style.display = 'none';
                    if (promptPayContainer) promptPayContainer.style.display = 'none';
                    if (creditCardContainer) creditCardContainer.style.display = 'none';
                    if (stripeButtonContainer) stripeButtonContainer.style.display = 'none';
                    if (emailMismatchWarning) emailMismatchWarning.style.display = 'none';
                    
                    // Show cookie consent button if not accepted
                    const cookieConsent = localStorage.getItem('cookieConsent');
                    if (!cookieConsent) {
                        const cookieConsentBtn = document.getElementById('cookieConsentBtn');
                        if (cookieConsentBtn) {
                            cookieConsentBtn.style.display = 'block';
                        }
                    }
                    
                    // Disable protected sections (show greyed-out with overlay)
                    if (aiThemeGrid) {
                        aiThemeGrid.classList.add('protected-disabled');
                    }
                    if (themeSelector) {
                        themeSelector.classList.add('protected-disabled');
                    }
                    
                    // Show login overlay in aiThemeGrid
                    const aiThemeOverlay = document.getElementById('aiThemeOverlay');
                    if (aiThemeOverlay) {
                        aiThemeOverlay.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('‚ùå Auth check failed:', error);
                // On error, assume not authenticated
                const authBtn = document.getElementById('authBtn');
                const userInfo = document.getElementById('userInfo');
                if (authBtn) {
                    authBtn.href = '/login';
                    authBtn.querySelector('span').textContent = 'üîê Login';
                }
                if (userInfo) {
                    userInfo.style.display = 'none';
                    userInfo.style.visibility = 'hidden';
                }
                // On error, disable sections
                const aiThemeGrid = document.getElementById('aiThemeGrid');
                const themeSelector = document.getElementById('themeSelector');
                if (aiThemeGrid) {
                    aiThemeGrid.classList.add('protected-disabled');
                }
                if (themeSelector) {
                    themeSelector.classList.add('protected-disabled');
                }
                
                // Show login overlay
                const aiThemeOverlay = document.getElementById('aiThemeOverlay');
                if (aiThemeOverlay) {
                    aiThemeOverlay.style.display = 'block';
                }
            }
        });
        
        // Re-check authentication after returning from Auth0 callback
        // This ensures UI updates when user comes back from login
        window.addEventListener('pageshow', async function(event) {
            // Check if we're coming back from Auth0 (page might be cached)
            const urlParams = new URLSearchParams(window.location.search);
            const hasCode = urlParams.has('code') || window.location.pathname === '/callback';
            
            if (event.persisted || hasCode || urlParams.get('auth') === 'callback') {
                console.log('üîÑ Page restored or returning from Auth0, re-checking authentication...');
                console.log('   URL:', window.location.href);
                console.log('   Event persisted:', event.persisted);
                
                // Wait a bit longer for session to be established
                setTimeout(async () => {
                    try {
                        const response = await fetch('/api/user', {
                            credentials: 'include',
                            cache: 'no-cache',
                            headers: {
                                'Cache-Control': 'no-cache'
                            }
                        });
                        const data = await response.json();
                        console.log('üîÑ Re-check auth response:', data);
                        updateAuthUI(data);
                        
                        // Clean up URL after check
                        if (hasCode || urlParams.get('auth') === 'callback') {
                            window.history.replaceState({}, document.title, window.location.pathname);
                        }
                    } catch (error) {
                        console.error('‚ùå Error re-checking auth after callback:', error);
                    }
                }, 1000); // Wait 1 second for session to be established
            }
        });
        
        // Also check on hashchange (in case Auth0 uses hash fragments)
        window.addEventListener('hashchange', async function() {
            if (window.location.hash.includes('code=') || window.location.hash.includes('access_token=')) {
                console.log('üîÑ Hash change detected, checking authentication...');
                setTimeout(async () => {
                    try {
                        const response = await fetch('/api/user', {
                            credentials: 'include',
                            cache: 'no-cache'
                        });
                        const data = await response.json();
                        updateAuthUI(data);
                    } catch (error) {
                        console.error('‚ùå Error checking auth after hash change:', error);
                    }
                }, 500);
            }
        });
        
        // Also check when page becomes visible (user returns to tab)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page became visible, re-check auth
                fetch('/api/user', {
                    credentials: 'include',
                    cache: 'no-cache'
                })
                    .then(r => r.json())
                    .then(data => {
                        updateAuthUI(data);
                    })
                    .catch(err => console.error('Error checking auth on visibility change:', err));
            }
        });
        
        // Additional check: After a short delay on page load, re-check auth
        // This catches cases where session is established after initial page load
        setTimeout(async () => {
            try {
                const response = await fetch('/api/user', {
                    credentials: 'include',
                    cache: 'no-cache'
                });
                const data = await response.json();
                
                // Only update if we got different result (user just logged in)
                const currentBtn = document.getElementById('authBtn');
                const currentBtnText = currentBtn?.querySelector('span')?.textContent || '';
                const shouldBeLoggedIn = data.authenticated && data.user;
                const currentlyLoggedIn = currentBtnText.includes('Logout');
                
                if (shouldBeLoggedIn !== currentlyLoggedIn) {
                    console.log('üîÑ Auth state changed, updating UI...');
                    updateAuthUI(data);
                }
            } catch (error) {
                console.error('Error in delayed auth check:', error);
            }
        }, 1000); // Check after 1 second
        
        // Test function for Generate Preview button
        window.testGeneratePreview = function() {
            console.log('üß™ Testing Generate Preview Button...');
            console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
            
            if (typeof window.generatePreview !== 'function') {
                console.error('‚ùå window.generatePreview is NOT a function!');
                console.error('   Type:', typeof window.generatePreview);
                return;
            }
            console.log('‚úÖ window.generatePreview exists');
            
            if (typeof window.showStatus !== 'function') {
                console.error('‚ùå window.showStatus is NOT defined!');
                return;
            }
            console.log('‚úÖ window.showStatus exists');
            
            if (typeof window.getApiKey !== 'function') {
                console.error('‚ùå window.getApiKey is NOT defined!');
                return;
            }
            console.log('‚úÖ window.getApiKey exists');
            
            const textInput = document.getElementById('textInput');
            const previewBtn = document.getElementById('previewBtn');
            
            if (!textInput) {
                console.error('‚ùå #textInput element NOT found!');
                return;
            }
            console.log('‚úÖ #textInput element exists');
            
            if (!previewBtn) {
                console.error('‚ùå #previewBtn element NOT found!');
                return;
            }
            console.log('‚úÖ #previewBtn element exists');
            
            console.log('');
            console.log('‚úÖ All checks passed! Generate Preview should work!');
            console.log('   (Requires API key to actually generate)');
        };
        
        // Test function for Expand Idea button
        window.testExpandIdea = function() {
            console.log('üß™ Testing Expand Idea Button...');
            console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
            
            if (typeof window.generateFromPrompt !== 'function') {
                console.error('‚ùå window.generateFromPrompt is NOT a function!');
                console.error('   Type:', typeof window.generateFromPrompt);
                return;
            }
            console.log('‚úÖ window.generateFromPrompt exists');
            
            if (typeof window.showStatus !== 'function') {
                console.error('‚ùå window.showStatus is NOT defined!');
                return;
            }
            console.log('‚úÖ window.showStatus exists');
            
            if (typeof window.getApiKey !== 'function') {
                console.error('‚ùå window.getApiKey is NOT defined!');
                return;
            }
            console.log('‚úÖ window.getApiKey exists');
            
            const ideaInput = document.getElementById('ideaInput');
            const promptBtn = document.getElementById('promptBtn');
            
            if (!ideaInput) {
                console.error('‚ùå #ideaInput element NOT found!');
                return;
            }
            console.log('‚úÖ #ideaInput element exists');
            
            if (!promptBtn) {
                console.error('‚ùå #promptBtn element NOT found!');
                return;
            }
            console.log('‚úÖ #promptBtn element exists');
            
            console.log('');
            console.log('‚úÖ All checks passed! Expand Idea should work!');
            console.log('   (Requires API key to actually generate)');
        };
        
        // Add keyboard shortcut for quick test
        document.addEventListener('keydown', function(e) {
            // Ctrl+Shift+D for diagnostics
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                e.preventDefault();
                console.clear();
                window.location.reload();
            }
            // Ctrl+Shift+T for test
            if (e.ctrlKey && e.shiftKey && e.key === 'T') {
                e.preventDefault();
                console.log('');
                testGeneratePreview();
                console.log('');
                testExpandIdea();
            }
        });
        
        // Check authentication state and update UI
        // Check for payment success/cancel messages
        function checkPaymentStatus() {
            const urlParams = new URLSearchParams(window.location.search);
            const paymentStatus = urlParams.get('payment');
            const sessionId = urlParams.get('session_id');
            
            if (paymentStatus === 'success' && sessionId) {
                console.log(`üéâ Payment successful! Session ID: ${sessionId}`);
                
                // Show success toast
                showPaymentSuccessToast(sessionId);
                
                // Clean URL (remove parameters)
                window.history.replaceState({}, document.title, window.location.pathname);
                
            } else if (paymentStatus === 'cancelled') {
                console.log(`‚ùå Payment cancelled`);
                
                // Show cancel toast
                showPaymentCancelToast();
                
                // Clean URL (remove parameters)
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // Function to show payment success toast
        function showPaymentSuccessToast(sessionId) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
                border: 2px solid #28a745;
                border-radius: 12px;
                padding: 1.5rem;
                max-width: 400px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.2);
                z-index: 10000;
                font-family: 'Inter', sans-serif;
                animation: slideInRight 0.3s ease-out;
            `;
            
            toast.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                    <div style="font-size: 1.5rem;">üéâ</div>
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #155724; font-size: 1rem; font-weight: 700;">Payment Successful!</h4>
                        <p style="margin: 0 0 0.75rem 0; color: #155724; font-size: 0.9rem; line-height: 1.4;">
                            Thank you for your payment! You now have premium access to GENIS.AI.
                        </p>
                        <p style="margin: 0; color: #155724; font-size: 0.85rem; font-weight: 600;">
                            üí° <strong>Session ID:</strong> ${sessionId.substring(0, 20)}...
                        </p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; font-size: 1.2rem; color: #155724; cursor: pointer; padding: 0; margin: 0;">
                        ‚úï
                    </button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideInRight 0.3s ease-out reverse';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 10000);
        }

        // Function to show payment cancel toast
        function showPaymentCancelToast() {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
                border: 2px solid #dc3545;
                border-radius: 12px;
                padding: 1.5rem;
                max-width: 400px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.2);
                z-index: 10000;
                font-family: 'Inter', sans-serif;
                animation: slideInRight 0.3s ease-out;
            `;
            
            toast.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                    <div style="font-size: 1.5rem;">‚ùå</div>
                    <div style="flex: 1;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #721c24; font-size: 1rem; font-weight: 700;">Payment Cancelled</h4>
                        <p style="margin: 0; color: #721c24; font-size: 0.9rem; line-height: 1.4;">
                            Your payment was cancelled. You can try again anytime using the payment buttons.
                        </p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; font-size: 1.2rem; color: #721c24; cursor: pointer; padding: 0; margin: 0;">
                        ‚úï
                    </button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remove after 8 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideInRight 0.3s ease-out reverse';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 8000);
        }

        // Function to show subscription explanation toast
        window.showSubscriptionExplanation = function() {
            // Get the warning button position
            const warningBtn = document.getElementById('subscriptionWarningBtn');
            if (!warningBtn) return;
            
            const rect = warningBtn.getBoundingClientRect();
            
            // Remove any existing toast
            const existingToast = document.getElementById('subscriptionExplanationToast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // Create minimal toast element positioned close to the button
            const toast = document.createElement('div');
            toast.id = 'subscriptionExplanationToast';
            toast.style.cssText = `
                position: fixed;
                top: ${rect.bottom + 8}px;
                left: ${rect.left}px;
                background: #fff3cd;
                border: 1px solid #ffc107;
                border-radius: 4px;
                padding: 0.5rem 0.75rem;
                max-width: 280px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                z-index: 10000;
                font-family: 'Inter', sans-serif;
                font-size: 0.75rem;
                color: #856404;
                animation: fadeIn 0.2s ease-out;
            `;
            
            toast.innerHTML = `
                ‚ö†Ô∏è <strong>Subscription not found:</strong> You may have subscribed using a different email. Use the payment buttons to subscribe.
                <button onclick="this.parentElement.remove()" 
                        style="float: right; background: none; border: none; font-size: 0.875rem; color: #856404; cursor: pointer; padding: 0; margin-left: 0.5rem; line-height: 1;">
                    ‚úï
                </button>
            `;
            
            // Add CSS animation if not already present
            if (!document.getElementById('toastAnimationStyle')) {
                const style = document.createElement('style');
                style.id = 'toastAnimationStyle';
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; transform: translateY(-4px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Add to page
            document.body.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'fadeIn 0.2s ease-out reverse';
                    setTimeout(() => toast.remove(), 200);
                }
            }, 5000);
        }

        // Function to create PromptPay subscription
        window.createPromptPaySubscription = async function() {
            try {
                const promptPayBtn = document.getElementById('promptPayBtn');
                const promptPayWarning = document.getElementById('promptPayWarning');
                
                // Show loading state (maintain icon-only format)
                promptPayBtn.innerHTML = '<span style="font-size: 1rem;">üîÑ</span>';
                promptPayBtn.disabled = true;
                
                const response = await fetch('/api/promptpay/subscription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: 29900, // 299 THB
                        interval: 'month',
                        productName: 'GENIS.AI Premium Subscription',
                        description: 'AI-powered presentation generation service'
                    })
                });
                
                const data = await response.json();
                
                if (data.url) {
                    // Show warning before redirecting
                    promptPayWarning.style.display = 'block';
                    promptPayWarning.innerHTML = `
                        ‚ö†Ô∏è <strong>Important:</strong> This checkout supports PromptPay and cards. PromptPay is single-use for one-time payments.
                        <br><br>Redirecting to payment checkout...
                    `;
                    
                    // Redirect to Stripe checkout
                    setTimeout(() => {
                        window.location.href = data.url;
                    }, 2000);
                } else {
                    throw new Error(data.error || 'Failed to create PromptPay session');
                }
                
            } catch (error) {
                console.error('Error creating PromptPay subscription:', error);
                alert('Failed to create PromptPay subscription: ' + error.message);
                
                // Reset button (restore icon-only format)
                const promptPayBtn = document.getElementById('promptPayBtn');
                promptPayBtn.innerHTML = '<img src="/icon-thaiqr.png" alt="Thai QR" style="width: 20px; height: 20px; object-fit: contain;">';
                promptPayBtn.disabled = false;
            }
        }

        // Function to create Credit Card subscription (recurring billing)
        window.createCreditCardSubscription = async function() {
            try {
                const creditCardBtn = document.getElementById('creditCardBtn');
                const creditCardWarning = document.getElementById('creditCardWarning');
                
                // Show loading state
                creditCardBtn.textContent = 'üîÑ Creating Subscription...';
                creditCardBtn.disabled = true;
                
                const response = await fetch('/api/creditcard/subscription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: 19900, // 199 THB monthly subscription
                        interval: 'month',
                        productName: 'GENIS.AI Subscription',
                        description: 'Monthly subscription with automatic renewal'
                    })
                });
                
                const data = await response.json();
                
                if (data.url) {
                    // Show success message before redirecting
                    if (creditCardWarning) {
                        creditCardWarning.style.display = 'block';
                        creditCardWarning.innerHTML = `
                            ‚úÖ <strong>Credit Card Subscription:</strong> This will auto-renew monthly.
                            <br><br>Redirecting to subscription checkout...
                        `;
                    }
                    
                    // Redirect to Stripe checkout
                    setTimeout(() => {
                        window.location.href = data.url;
                    }, 2000);
                } else {
                    throw new Error(data.error || 'Failed to create credit card subscription session');
                }
                
            } catch (error) {
                console.error('Error creating credit card subscription:', error);
                alert('Failed to create credit card subscription: ' + error.message);
                
                // Reset button
                const creditCardBtn = document.getElementById('creditCardBtn');
                creditCardBtn.innerHTML = '<span style="font-size: 0.8rem;">üí≥</span><span>Subscribe</span>';
                creditCardBtn.disabled = false;
            }
        }

        // Function to check subscription status
        window.checkSubscriptionStatus = async function() {
            // CRITICAL: Only check subscription for logged-in users
            // First verify user is authenticated by checking the payment buttons row visibility
            const paymentButtonsRow = document.getElementById('paymentButtonsRow');
            if (!paymentButtonsRow || paymentButtonsRow.style.display === 'none') {
                console.log('‚ö†Ô∏è Skipping subscription check - user not logged in');
                return; // Don't show any buttons for non-logged-in users
            }
            
            try {
                console.log('üîç Checking subscription status...');
                const response = await fetch('/api/subscription');
                const subscriptionData = await response.json();
                console.log('üìä Subscription data:', subscriptionData);
                
                const subscriptionStatus = document.getElementById('subscriptionStatus');
                const subscriptionBadge = document.getElementById('subscriptionBadge');
                const emailMismatchWarning = document.getElementById('emailMismatchWarning');
                const stripeBuyButton = document.querySelector('stripe-buy-button');
                const promptPayContainer = document.getElementById('promptPayContainer');
                const creditCardContainer = document.getElementById('creditCardContainer');
                const subscriptionWarningBtn = document.getElementById('subscriptionWarningBtn');
                const stripeButtonContainer = document.getElementById('stripeButtonContainer');
                
                if (subscriptionData.hasActiveSubscription) {
                    // User has active subscription - hide ALL payment buttons and warning
                    // Show the row (for slide count) but hide all payment elements
                    const paymentButtonsRow = document.getElementById('paymentButtonsRow');
                    if (paymentButtonsRow) {
                        paymentButtonsRow.style.display = 'flex'; // Show row for slide count
                    }
                    
                    // Hide warning button
                    if (subscriptionWarningBtn) {
                        subscriptionWarningBtn.style.display = 'none';
                    }
                    
                    // Hide both payment buttons
                    if (promptPayContainer) {
                        promptPayContainer.style.display = 'none';
                    }
                    if (creditCardContainer) {
                        creditCardContainer.style.display = 'none';
                    }
                    if (stripeButtonContainer) {
                        stripeButtonContainer.style.display = 'none';
                    }
                    
                    // Hide buy button and show subscription management link
                    if (stripeButtonContainer) {
                        const currentContent = stripeButtonContainer.innerHTML.trim();
                        const manageLinkHtml = `https://billing.stripe.com/p/login/cNi3cv1GIcNT44zbzldnW00`;
                        // Only update if not already showing the manage link
                        if (!currentContent.includes(manageLinkHtml) && !currentContent.includes('Manage Subscription')) {
                            stripeButtonContainer.innerHTML = `
                                <a href="https://billing.stripe.com/p/login/cNi3cv1GIcNT44zbzldnW00" 
                                   target="_blank" 
                                   rel="noopener noreferrer"
                                   style="display: inline-flex; align-items: center; justify-content: center; padding: 0 1.5rem; height: 44px; min-height: 44px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 0.9rem; text-align: center; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                   onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'"
                                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                                    üí≥ Manage Subscription
                                </a>
                            `;
                            stripeButtonContainer.style.display = 'block';
                        }
                    }
                    
                    // Show email mismatch warning if emails don't match exactly
                    if (subscriptionData.emailMismatchWarning && !subscriptionData.exactEmailMatch) {
                        emailMismatchWarning.innerHTML = `
                            ‚ö†Ô∏è <strong>Subscription not found:</strong> You may have subscribed using a different email address.
                        `;
                        emailMismatchWarning.style.display = 'block';
                        
                        // Show buy button instead of manage subscription for email mismatch
                        const stripeButtonContainer = document.getElementById('stripeButtonContainer');
                        if (stripeButtonContainer) {
                            const currentContent = stripeButtonContainer.innerHTML.trim();
                            // Only update if not already showing the buy button
                            if (!currentContent.includes('stripe-buy-button') && !currentContent.includes('buy_btn_1SN5z9GfwbNFFG53MZKQw2qX')) {
                                stripeButtonContainer.innerHTML = `
                                    <stripe-buy-button
                                        buy-button-id="buy_btn_1SN5z9GfwbNFFG53MZKQw2qX"
                                        publishable-key="pk_live_51OKYdlGfwbNFFG53ez9b6nQ0KuURqAwPV5TJNr4HSTq1MhLpoQoa38iceUvx4vpu5yFxgORYKOzV0Vfsn7GzixlU00ffZcxaVD"
                                        style="flex: 0 0 auto;"
                                    >
                                    </stripe-buy-button>
                                `;
                            }
                        }
                    } else {
                        emailMismatchWarning.style.display = 'none';
                    }
                    
                } else if (subscriptionData.customerExists) {
                    // Customer exists but no active subscription - show buy button and warning
                    // Show the payment buttons row
                    const paymentButtonsRow = document.getElementById('paymentButtonsRow');
                    if (paymentButtonsRow) {
                        paymentButtonsRow.style.display = 'flex';
                    }
                    
                    // Show warning button (yellow warning button, not text)
                    if (subscriptionWarningBtn) {
                        console.log('üü° Showing warning button - customer exists but no active subscription');
                        subscriptionWarningBtn.style.display = 'flex'; // Use flex to match parent container
                    } else {
                        console.log('‚ùå Warning button element not found');
                    }
                    
                    // Show buy button (only if not already showing)
                    const stripeButtonContainer = document.getElementById('stripeButtonContainer');
                    if (stripeButtonContainer) {
                        const currentContent = stripeButtonContainer.innerHTML.trim();
                        // Only update if not already showing the buy button
                        if (!currentContent.includes('stripe-buy-button') && !currentContent.includes('buy_btn_1SN5z9GfwbNFFG53MZKQw2qX')) {
                            stripeButtonContainer.innerHTML = `
                                <stripe-buy-button
                                    buy-button-id="buy_btn_1SN5z9GfwbNFFG53MZKQw2qX"
                                    publishable-key="pk_live_51OKYdlGfwbNFFG53ez9b6nQ0KuURqAwPV5TJNr4HSTq1MhLpoQoa38iceUvx4vpu5yFxgORYKOzV0Vfsn7GzixlU00ffZcxaVD"
                                    style="flex: 0 0 auto;"
                                >
                                </stripe-buy-button>
                            `;
                        }
                    }
                    
                    // Show correct payment buttons: Warning button, PromptPay button, and Stripe button
                    console.log('üîÑ Showing payment buttons for logged-in user without active subscription');
                    if (promptPayContainer) {
                        console.log('‚úÖ Showing PromptPay button');
                        promptPayContainer.style.display = 'flex'; // Use flex to match parent container
                    } else {
                        console.log('‚ùå PromptPay container not found');
                    }
                    
                    // Hide Credit Card button (not part of correct set)
                    if (creditCardContainer) {
                        console.log('üö´ Hiding Credit Card button');
                        creditCardContainer.style.display = 'none';
                    }
                    
                    // Ensure Stripe button container is also visible with correct content
                    if (stripeButtonContainer) {
                        console.log('‚úÖ Showing Stripe button');
                        // Ensure it has the stripe-buy-button element
                        const currentStripeContent = stripeButtonContainer.innerHTML.trim();
                        if (!currentStripeContent.includes('stripe-buy-button') && !currentStripeContent.includes('buy_btn_1SN5z9GfwbNFFG53MZKQw2qX')) {
                            stripeButtonContainer.innerHTML = `
                                <stripe-buy-button
                                    buy-button-id="buy_btn_1SN5z9GfwbNFFG53MZKQw2qX"
                                    publishable-key="pk_live_51OKYdlGfwbNFFG53ez9b6nQ0KuURqAwPV5TJNr4HSTq1MhLpoQoa38iceUvx4vpu5yFxgORYKOzV0Vfsn7GzixlU00ffZcxaVD"
                                    style="flex: 0 0 auto;"
                                >
                                </stripe-buy-button>
                            `;
                        }
                        stripeButtonContainer.style.display = 'block';
                    } else {
                        console.log('‚ùå Stripe button container not found');
                    }
                    
                    // Show email mismatch warning if emails don't match exactly
                    if (subscriptionData.emailMismatchWarning && !subscriptionData.exactEmailMatch) {
                        emailMismatchWarning.innerHTML = `
                            ‚ö†Ô∏è <strong>Subscription not found:</strong> You may have subscribed using a different email address.
                        `;
                        emailMismatchWarning.style.display = 'block';
                    } else {
                        emailMismatchWarning.style.display = 'none';
                    }
                    
                } else {
                    // No customer found - show buy button with warning
                    // Note: subscriptionStatus is hidden with !important CSS
                    
                    // Show the payment buttons row
                    const paymentButtonsRow = document.getElementById('paymentButtonsRow');
                    if (paymentButtonsRow) {
                        paymentButtonsRow.style.display = 'flex';
                    }
                    
                    // Show warning button (yellow warning button, not text)
                    if (subscriptionWarningBtn) {
                        console.log('üü° Showing warning button - no customer found');
                        subscriptionWarningBtn.style.display = 'flex'; // Use flex to match parent container
                    } else {
                        console.log('‚ùå Warning button element not found');
                    }
                    
                    // Show buy button (only if not already showing)
                    const stripeButtonContainer = document.getElementById('stripeButtonContainer');
                    if (stripeButtonContainer) {
                        const currentContent = stripeButtonContainer.innerHTML.trim();
                        // Only update if not already showing the buy button
                        if (!currentContent.includes('stripe-buy-button') && !currentContent.includes('buy_btn_1SN5z9GfwbNFFG53MZKQw2qX')) {
                            stripeButtonContainer.innerHTML = `
                                <stripe-buy-button
                                    buy-button-id="buy_btn_1SN5z9GfwbNFFG53MZKQw2qX"
                                    publishable-key="pk_live_51OKYdlGfwbNFFG53ez9b6nQ0KuURqAwPV5TJNr4HSTq1MhLpoQoa38iceUvx4vpu5yFxgORYKOzV0Vfsn7GzixlU00ffZcxaVD"
                                    style="flex: 0 0 auto;"
                                >
                                </stripe-buy-button>
                            `;
                        }
                    }
                    
                    // Show correct payment buttons: Warning button, PromptPay button, and Stripe button
                    console.log('üîÑ Showing payment buttons for logged-in user (no customer found)');
                    if (promptPayContainer) {
                        console.log('‚úÖ Showing PromptPay button');
                        promptPayContainer.style.display = 'flex'; // Use flex to match parent container
                    } else {
                        console.log('‚ùå PromptPay container not found');
                    }
                    
                    // Hide Credit Card button (not part of correct set)
                    if (creditCardContainer) {
                        console.log('üö´ Hiding Credit Card button');
                        creditCardContainer.style.display = 'none';
                    }
                    
                    // Ensure Stripe button container is also visible with correct content
                    if (stripeButtonContainer) {
                        console.log('‚úÖ Showing Stripe button');
                        // Ensure it has the stripe-buy-button element
                        const currentStripeContent2 = stripeButtonContainer.innerHTML.trim();
                        if (!currentStripeContent2.includes('stripe-buy-button') && !currentStripeContent2.includes('buy_btn_1SN5z9GfwbNFFG53MZKQw2qX')) {
                            stripeButtonContainer.innerHTML = `
                                <stripe-buy-button
                                    buy-button-id="buy_btn_1SN5z9GfwbNFFG53MZKQw2qX"
                                    publishable-key="pk_live_51OKYdlGfwbNFFG53ez9b6nQ0KuURqAwPV5TJNr4HSTq1MhLpoQoa38iceUvx4vpu5yFxgORYKOzV0Vfsn7GzixlU00ffZcxaVD"
                                    style="flex: 0 0 auto;"
                                >
                                </stripe-buy-button>
                            `;
                        }
                        stripeButtonContainer.style.display = 'block';
                    } else {
                        console.log('‚ùå Stripe button container not found');
                    }
                    
                    // Show email mismatch warning ONLY if there's an actual email mismatch
                    if (subscriptionData.emailMismatchWarning && !subscriptionData.exactEmailMatch) {
                        emailMismatchWarning.innerHTML = `
                            ‚ö†Ô∏è <strong>Subscription not found:</strong> You may have subscribed using a different email address.
                        `;
                        emailMismatchWarning.style.display = 'block';
                    } else {
                        emailMismatchWarning.style.display = 'none';
                    }
                }
                
            } catch (error) {
                console.error('Error checking subscription status:', error);
                // Hide subscription status on error
                const subscriptionStatus = document.getElementById('subscriptionStatus');
                subscriptionStatus.style.display = 'none';
                
                // Show buy button as fallback (only if not already showing)
                const stripeButtonContainer = document.getElementById('stripeButtonContainer');
                if (stripeButtonContainer) {
                    const currentContent = stripeButtonContainer.innerHTML.trim();
                    // Only update if not already showing the buy button
                    if (!currentContent.includes('stripe-buy-button') && !currentContent.includes('buy_btn_1SN5z9GfwbNFFG53MZKQw2qX')) {
                        stripeButtonContainer.innerHTML = `
                            <stripe-buy-button
                                buy-button-id="buy_btn_1SN5z9GfwbNFFG53MZKQw2qX"
                                publishable-key="pk_live_51OKYdlGfwbNFFG53ez9b6nQ0KuURqAwPV5TJNr4HSTq1MhLpoQoa38iceUvx4vpu5yFxgORYKOzV0Vfsn7GzixlU00ffZcxaVD"
                                style="flex: 0 0 auto;"
                            >
                            </stripe-buy-button>
                        `;
                    }
                }
                
                // Show payment buttons row as fallback
                const paymentButtonsRow = document.getElementById('paymentButtonsRow');
                if (paymentButtonsRow) {
                    paymentButtonsRow.style.display = 'flex';
                }
                
                // Show correct payment buttons as fallback: Warning button, PromptPay button, and Stripe button
                const subscriptionWarningBtn = document.getElementById('subscriptionWarningBtn');
                const promptPayContainer = document.getElementById('promptPayContainer');
                const creditCardContainer = document.getElementById('creditCardContainer');
                const stripeButtonContainer = document.getElementById('stripeButtonContainer');
                
                if (subscriptionWarningBtn) {
                    console.log('‚úÖ Showing warning button (error fallback)');
                    subscriptionWarningBtn.style.display = 'flex';
                }
                if (promptPayContainer) {
                    console.log('‚úÖ Showing PromptPay button (error fallback)');
                    promptPayContainer.style.display = 'flex'; // Use flex to match parent container
                }
                
                // Hide Credit Card button (not part of correct set)
                if (creditCardContainer) {
                    console.log('üö´ Hiding Credit Card button (error fallback)');
                    creditCardContainer.style.display = 'none';
                }
                
                // Ensure Stripe button container is visible with correct content
                if (stripeButtonContainer) {
                    console.log('‚úÖ Showing Stripe button (error fallback)');
                    // Ensure it has the stripe-buy-button element
                    const currentContent = stripeButtonContainer.innerHTML.trim();
                    if (!currentContent.includes('stripe-buy-button') && !currentContent.includes('buy_btn_1SN5z9GfwbNFFG53MZKQw2qX')) {
                        stripeButtonContainer.innerHTML = `
                            <stripe-buy-button
                                buy-button-id="buy_btn_1SN5z9GfwbNFFG53MZKQw2qX"
                                publishable-key="pk_live_51OKYdlGfwbNFFG53ez9b6nQ0KuURqAwPV5TJNr4HSTq1MhLpoQoa38iceUvx4vpu5yFxgORYKOzV0Vfsn7GzixlU00ffZcxaVD"
                                style="flex: 0 0 auto;"
                            >
                            </stripe-buy-button>
                        `;
                    }
                    stripeButtonContainer.style.display = 'block';
                }
            }
        }

    </script>
    
    <!-- Cookie and Slide Tracking for Non-Logged-In Users -->
    <script>
        /**
         * Cookie utilities for tracking slide count
         */
        function setCookie(name, value, days = 365) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Lax`;
        }
        
        function getCookie(name) {
            const nameEQ = name + '=';
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }
        
        /**
         * Accept cookies and hide consent button
         */
        window.acceptCookies = function() {
            localStorage.setItem('cookieConsent', 'accepted');
            setCookie('cookieConsent', 'accepted', 365);
            
            const cookieConsentBtn = document.getElementById('cookieConsentBtn');
            if (cookieConsentBtn) {
                cookieConsentBtn.style.display = 'none';
            }
            
            console.log('‚úÖ Cookie consent accepted');
        };
        
        /**
         * Track slide count in cookie for non-logged-in users
         */
        function updateSlideCountCookie(slideCount) {
            const cookieConsent = getCookie('cookieConsent') || localStorage.getItem('cookieConsent');
            if (cookieConsent === 'accepted') {
                const currentCount = parseInt(getCookie('slideCount') || '0', 10);
                const newCount = currentCount + slideCount;
                setCookie('slideCount', newCount.toString(), 365);
                console.log(`üìä Updated slide count cookie: ${newCount} slides`);
                
                // Show warning if approaching limit (optional)
                if (newCount >= 50) {
                    // Could show a warning here
                }
            }
        }
        
        /**
         * Get slide count from cookie for non-logged-in users
         */
        function getSlideCountCookie() {
            const cookieConsent = getCookie('cookieConsent') || localStorage.getItem('cookieConsent');
            if (cookieConsent === 'accepted') {
                return parseInt(getCookie('slideCount') || '0', 10);
            }
            return 0;
        }
        
        // Initialize cookie consent button display on page load
        window.addEventListener('load', () => {
            const cookieConsent = getCookie('cookieConsent') || localStorage.getItem('cookieConsent');
            const userResponse = fetch('/api/user').then(r => r.json()).catch(() => ({ authenticated: false }));
            
            userResponse.then(userData => {
                if (!userData.authenticated && !cookieConsent) {
                    const cookieConsentBtn = document.getElementById('cookieConsentBtn');
                    if (cookieConsentBtn) {
                        cookieConsentBtn.style.display = 'block';
                    }
                }
            });
        });
        
        // Export functions
        window.setCookie = setCookie;
        window.getCookie = getCookie;
        window.updateSlideCountCookie = updateSlideCountCookie;
        window.getSlideCountCookie = getSlideCountCookie;
    </script>
    
    <!-- GitHub Buttons Script -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
</body>
</html>