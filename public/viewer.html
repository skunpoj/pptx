<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Presentation Viewer</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        .viewer-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .viewer-header {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .viewer-header h1 {
            margin: 0 0 0.5rem 0;
            color: #667eea;
            font-size: 2rem;
        }
        
        .viewer-meta {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            color: #666;
            font-size: 0.9rem;
        }
        
        .viewer-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .btn-secondary:hover {
            background: #f0f4ff;
        }
        
        .btn-success {
            background: #10B981;
            color: white;
            border: 2px solid #10B981;
        }
        
        .btn-success:hover {
            background: #059669;
            border-color: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .slide-viewer {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .slide-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            margin: 2rem 0;
        }
        
        .slide-counter {
            font-size: 1.2rem;
            font-weight: 600;
            color: #667eea;
            min-width: 100px;
            text-align: center;
        }
        
        .loading {
            text-align: center;
            padding: 4rem;
            color: white;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            text-align: center;
            padding: 3rem;
            color: white;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        .share-info {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
        
        .share-url-container {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .share-url-input {
            flex: 1;
            padding: 0.5rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-family: monospace;
        }
        
        /* Responsive layout for two-column section */
        @media (max-width: 768px) {
            #allSlidesContainer > div > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }
        }
        
        /* Spinner animation for loading states */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div class="viewer-container">
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p style="font-size: 1.2rem; margin: 0;">Loading presentation...</p>
        </div>
        
        <div id="errorState" class="error" style="display: none;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùå</div>
            <h2 style="margin: 0 0 0.5rem 0;">Presentation Not Found</h2>
            <p id="errorMessage" style="opacity: 0.8;"></p>
            <a href="/" class="btn btn-primary" style="margin-top: 1.5rem;">‚Üê Create New Presentation</a>
        </div>
        
        <div id="viewerContent" style="display: none;">
            <div class="viewer-header">
                <h1 id="presentationTitle">üìä Presentation Title</h1>
                <div class="viewer-meta">
                    <span id="slideCount">0 slides</span>
                    <span id="viewCount">0 views</span>
                    <span id="createdDate">Created just now</span>
                </div>
                
                <div class="viewer-actions">
                    <!-- Primary Actions -->
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1rem;">
                        <button class="btn btn-success" onclick="downloadPresentation()">
                            üì• Download PPT
                        </button>
                        <a class="btn btn-secondary" id="viewPDFLink" href="#" target="_blank" style="text-decoration: none;">
                            üìÑ View PDF
                        </a>
                        <button class="btn btn-secondary" onclick="copyShareLink()">
                            üìã Copy Link
                        </button>
                        <a href="/" class="btn btn-secondary" style="text-decoration: none;">
                            ‚ú® Create New
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Slide Viewer - All slides in one page -->
            <div class="slide-viewer" id="slideViewerContainer">
                <div id="allSlidesContainer" style="display: flex; flex-direction: column; gap: 2rem;"></div>
            </div>
        </div>
    </div>

    <!-- Load dependencies -->
    <script src="/js/themes.js"></script>
    <script src="/js/preview.js"></script>
    <script src="/js/charts.js"></script>
    
    <script>
        // Get share ID from URL
        const shareId = window.location.pathname.split('/').pop();
        let currentSlideIndex = 0;
        let presentationData = null;
        let sessionId = null;  // Store sessionId for PDF and download access
        
        // Load shared presentation with GUARANTEED retry logic
        async function loadSharedPresentation() {
            const maxAttempts = 5; // Try 5 times
            let lastError = null;
            
            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                try {
                    console.log(`üì• Loading presentation (attempt ${attempt}/${maxAttempts})...`);
                    
                    const response = await fetch(`/api/shared-presentation/${shareId}`);
                    
                    if (!response.ok) {
                        throw new Error(`Server returned ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // CRITICAL: Verify data is complete
                    if (!data.slideData || !data.slideData.slides || data.slideData.slides.length === 0) {
                        throw new Error('Incomplete presentation data received');
                    }
                    
                    console.log(`‚úÖ Presentation loaded successfully on attempt ${attempt}`);
                    console.log(`   Slides: ${data.slideData.slides.length}`);
                    console.log(`   SessionId: ${data.sessionId || 'none'}`);
                    
                    presentationData = data;
                    sessionId = data.sessionId;  // Store sessionId for PDF access
                    
                    // Display presentation
                    displayPresentation(data);
                    return; // SUCCESS - exit function
                    
                } catch (error) {
                    lastError = error;
                    console.warn(`‚ö†Ô∏è Attempt ${attempt} failed:`, error.message);
                    
                    // If this is the last attempt, show error
                    if (attempt === maxAttempts) {
                        console.error('‚ùå All attempts failed:', error);
                        showError(`Failed to load presentation after ${maxAttempts} attempts.\n\nError: ${error.message}\n\nPlease refresh the page or contact support.`);
                        return;
                    }
                    
                    // Wait before retry (exponential backoff)
                    const waitTime = attempt * 1000; // 1s, 2s, 3s, 4s
                    console.log(`   Waiting ${waitTime}ms before retry...`);
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
            }
        }
        
        function displayPresentation(data) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('viewerContent').style.display = 'block';
            
            // Update header
            document.getElementById('presentationTitle').textContent = `üìä ${data.title}`;
            document.getElementById('slideCount').textContent = `${data.slideData.slides.length} slides`;
            document.getElementById('viewCount').textContent = `${data.views} views`;
            
            const createdDate = new Date(data.createdAt).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
            document.getElementById('createdDate').textContent = `Created ${createdDate}`;
            
            // Store slide data globally
            window.currentSlideData = data.slideData;
            
            // Set up PDF link and start auto-checking for PDF availability
            const pdfLink = document.getElementById('viewPDFLink');
            if (pdfLink && sessionId) {
                pdfLink.href = `/view-pdf/${sessionId}`;
                
                // Start with "generating" state
                pdfLink.textContent = '‚è≥ PDF Generating...';
                pdfLink.style.opacity = '0.6';
                pdfLink.style.cursor = 'wait';
                pdfLink.onclick = (e) => {
                    e.preventDefault();
                    alert('‚è≥ PDF is being generated in the background. Please wait...');
                };
                
                console.log('‚è≥ Starting automatic PDF availability check...');
                
                // Start automatic checking for PDF
                startPDFAvailabilityCheck(sessionId, pdfLink);
                
            } else if (pdfLink) {
                // No sessionId - disable the link
                pdfLink.textContent = 'üìÑ PDF Unavailable';
                pdfLink.style.opacity = '0.5';
                pdfLink.style.cursor = 'not-allowed';
                pdfLink.onclick = (e) => {
                    e.preventDefault();
                    alert('‚ùå PDF not available - no session ID found.');
                };
            }
            
            // Display all slides
            displayAllSlides();
        }
        
        /**
         * Automatically check for PDF availability and enable button when ready
         */
        async function startPDFAvailabilityCheck(sessionId, pdfLink) {
            const pdfUrl = `/view-pdf/${sessionId}`;
            let attempts = 0;
            const maxAttempts = 60; // Check for up to 60 seconds
            
            const checkInterval = setInterval(async () => {
                attempts++;
                
                try {
                    // Check if PDF is ready
                    const response = await fetch(pdfUrl, { method: 'HEAD' });
                    
                    if (response.ok) {
                        // ‚úÖ PDF IS READY!
                        clearInterval(checkInterval);
                        
                        console.log(`‚úÖ PDF ready after ${attempts} checks (${attempts} seconds)`);
                        
                        // Update button to enabled state
                        pdfLink.textContent = 'üìÑ View PDF';
                        pdfLink.style.opacity = '1';
                        pdfLink.style.cursor = 'pointer';
                        pdfLink.onclick = (e) => {
                            e.preventDefault();
                            window.open(pdfUrl, '_blank');
                            console.log('‚úÖ PDF opened in new window');
                        };
                        
                        // Show success notification
                        if (typeof alert !== 'undefined' && attempts > 5) {
                            // Only show if it took a while
                            setTimeout(() => {
                                alert('‚úÖ PDF is now ready to view!');
                            }, 500);
                        }
                        
                        return;
                    }
                } catch (error) {
                    // PDF not ready yet, continue checking
                    console.log(`‚è≥ PDF check ${attempts}/${maxAttempts} - not ready yet`);
                }
                
                // Update button text to show progress
                if (attempts % 5 === 0) {
                    pdfLink.textContent = `‚è≥ PDF Generating... (${attempts}s)`;
                }
                
                // Timeout after max attempts
                if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    console.warn('‚ö†Ô∏è PDF generation timeout after 60 seconds');
                    
                    // Change to "Try Generate" button
                    pdfLink.textContent = 'üîÑ Generate PDF';
                    pdfLink.style.opacity = '1';
                    pdfLink.style.cursor = 'pointer';
                    pdfLink.style.background = '#ffc107';
                    pdfLink.onclick = (e) => {
                        e.preventDefault();
                        openPDFInNewWindow();
                    };
                }
            }, 1000); // Check every second
        }
        
        function displayAllSlides() {
            const slides = window.currentSlideData.slides;
            const theme = window.currentSlideData.designTheme || {
                name: 'Default Theme',
                colorPrimary: '#667eea',
                colorSecondary: '#764ba2',
                colorAccent: '#F39C12',
                colorBackground: '#FFFFFF',
                colorText: '#1d1d1d'
            };
            
            const container = document.getElementById('allSlidesContainer');
            container.innerHTML = '';
            
            // Render all slides with modify prompts
            slides.forEach((slide, index) => {
                const slideCard = document.createElement('div');
                slideCard.id = `slideCard_${index}`;
                slideCard.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 2rem;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                    border: 2px solid #e0e0e0;
                    margin-bottom: 2rem;
                `;
                
                // Slide number badge
                const badge = document.createElement('div');
                badge.style.cssText = `
                    display: inline-block;
                    background: ${theme.colorAccent || '#F39C12'};
                    color: white;
                    padding: 0.5rem 1rem;
                    border-radius: 8px;
                    font-weight: bold;
                    font-size: 0.9rem;
                    margin-bottom: 1.5rem;
                `;
                badge.textContent = `Slide ${index + 1} of ${slides.length}`;
                slideCard.appendChild(badge);
                
                // Two-column layout: Modify prompt (left) + Slide preview (right)
                const slideLayout = document.createElement('div');
                slideLayout.innerHTML = renderSlideWithModifyPrompt(slide, index, theme);
                slideCard.appendChild(slideLayout);
                
                container.appendChild(slideCard);
            });
            
        }
        
        function renderSlideWithModifyPrompt(slide, index, theme) {
            // Create two-column layout: Modify prompt (left) + Slide preview (right)
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                    <!-- LEFT: Modify Prompt -->
                    <div style="background: linear-gradient(135deg, #fff8e1, #ffe4b3); border: 2px solid #ffc107; border-radius: 8px; padding: 1.5rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #f57c00; font-size: 1.1rem;">
                            ‚úèÔ∏è Modify This Slide
                        </h4>
                        <textarea 
                            id="modifyPrompt_${index}" 
                            placeholder="Enter modification prompt (e.g., 'Add more details about...' or 'Change title to...')"
                            style="width: 100%; height: 100px; padding: 0.75rem; border: 1px solid #ffc107; border-radius: 6px; font-size: 0.9rem; resize: vertical; font-family: inherit; margin-bottom: 1rem;"
                        ></textarea>
                        <button 
                            onclick="modifySlideIndividually(${index})"
                            style="width: 100%; background: #f57c00; color: white; border: none; border-radius: 6px; padding: 0.75rem; font-weight: 600; cursor: pointer; font-size: 1rem;"
                        >
                            üîÑ Modify Slide ${index + 1}
                        </button>
                        <p style="margin: 0.75rem 0 0 0; font-size: 0.85rem; color: #666; font-style: italic;">
                            üí° Only this slide will be updated
                        </p>
                    </div>
                    
                    <!-- RIGHT: Slide Preview -->
                    <div id="slidePreview_${index}" style="background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 1.5rem;">
                        ${renderSlideContent(slide, theme)}
                    </div>
                </div>
            `;
        }
        
        function renderSlideContent(slide, theme) {
            if (slide.type === 'title') {
                return `
                    <div style="text-align: center; padding: 2rem 0;">
                        <h2 style="color: ${theme.colorPrimary}; margin: 0 0 1rem 0; font-size: 2rem;">
                            ${slide.title}
                        </h2>
                        ${slide.subtitle ? `
                            <p style="color: ${theme.colorSecondary}; font-size: 1.2rem; margin: 0;">
                                ${slide.subtitle}
                            </p>
                        ` : ''}
                    </div>
                `;
            } else if (slide.type === 'content') {
                let html = `
                    <h3 style="color: ${theme.colorPrimary}; margin: 0 0 1rem 0; font-size: 1.5rem;">
                        ${slide.title}
                    </h3>
                `;
                
                if (slide.header) {
                    html += `
                        <p style="color: #666; font-style: italic; margin: 0 0 1rem 0;">
                            ${slide.header}
                        </p>
                    `;
                }
                
                if (slide.layout === 'chart' && slide.chart) {
                    html += `
                        <div style="background: #f8f9fa; border: 2px solid ${theme.colorAccent}; border-radius: 8px; padding: 1.5rem; margin: 1rem 0;">
                            <div style="font-weight: 600; color: ${theme.colorPrimary}; margin-bottom: 1rem; text-align: center; font-size: 1.1rem;">
                                üìä ${slide.chart.title || 'Chart'}
                            </div>
                            <div style="text-align: center;">
                                ${typeof window.generateChartSVG === 'function' ? 
                                    window.generateChartSVG(slide.chart, theme, 600, 350) : 
                                    '<p>Chart rendering not available</p>'}
                            </div>
                        </div>
                    `;
                }
                
                if (slide.content && slide.content.length > 0) {
                    html += `
                        <ul style="color: ${theme.colorText}; line-height: 1.8; margin: 1rem 0; font-size: 1rem;">
                            ${slide.content.map(item => `<li style="margin: 0.5rem 0;">${item}</li>`).join('')}
                        </ul>
                    `;
                }
                
                if (slide.imageUrl) {
                    html += `
                        <div style="margin-top: 1.5rem; text-align: center;">
                            <img src="${slide.imageUrl}" 
                                 alt="${slide.imageDescription || 'Slide image'}" 
                                 style="max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div style="display: none; background: #f0f4ff; border: 2px dashed ${theme.colorAccent}; padding: 1rem; border-radius: 8px; color: #666;">
                                üñºÔ∏è Image failed to load
                            </div>
                        </div>
                    `;
                } else if (slide.imageDescription) {
                    html += `
                        <div style="margin-top: 1.5rem; background: #f0f4ff; border: 2px dashed ${theme.colorAccent}; padding: 1.5rem; border-radius: 8px;">
                            <div style="font-weight: 600; color: ${theme.colorPrimary}; margin-bottom: 0.5rem; font-size: 1rem;">
                                üñºÔ∏è Image Placeholder
                            </div>
                            <div style="font-size: 0.95rem; color: #666; font-style: italic;">
                                ${slide.imageDescription}
                            </div>
                        </div>
                    `;
                }
                
                return html;
            }
            
            return '';
        }
        
        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }
        
        async function downloadPresentation() {
            console.log('üì• Download requested, sessionId:', sessionId);
            
            if (!sessionId) {
                alert('‚ùå Download not available - no session ID found.\n\nThis share link may not have the presentation file saved. Please ask the creator to regenerate the presentation.');
                return;
            }
            
            try {
                // First try to download directly
                console.log('üì• Attempting download from:', `/download/${sessionId}/presentation.pptx`);
                
                // Use window.location for direct download
                window.location.href = `/download/${sessionId}/presentation.pptx`;
                
                // Show message after a moment
                setTimeout(() => {
                    console.log('‚úÖ Download initiated');
                }, 300);
                
            } catch (error) {
                console.error('‚ùå Download error:', error);
                alert('‚ùå Download failed: ' + error.message + '\n\nPossible reasons:\n' +
                      '‚Ä¢ The presentation file was not saved\n' +
                      '‚Ä¢ The file has expired (24 hours)\n' +
                      '‚Ä¢ Please contact the creator to regenerate the presentation');
            }
        }
        
        function copyShareLink() {
            const shareUrl = window.location.href;
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert('‚úÖ Share link copied to clipboard!');
            }).catch(() => {
                prompt('Copy this link:', shareUrl);
            });
        }
        
        async function modifySlideIndividually(slideIndex) {
            const promptTextarea = document.getElementById(`modifyPrompt_${slideIndex}`);
            const modificationPrompt = promptTextarea ? promptTextarea.value.trim() : '';
            
            if (!modificationPrompt) {
                alert('‚ùå Please enter a modification prompt');
                return;
            }
            
            if (!window.currentSlideData || !window.currentSlideData.slides[slideIndex]) {
                alert('‚ùå Slide data not found');
                return;
            }
            
            console.log('üîÑ Modifying slide', slideIndex, 'with prompt:', modificationPrompt);
            
            const originalSlide = window.currentSlideData.slides[slideIndex];
            const theme = window.currentSlideData.designTheme;
            
            // Show loading state in the slide preview
            const slidePreview = document.getElementById(`slidePreview_${slideIndex}`);
            if (slidePreview) {
                slidePreview.innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <div class="spinner" style="width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                        <p style="margin-top: 1rem; color: #667eea;">‚è≥ Modifying slide...</p>
                    </div>
                `;
            }
            
            try {
                console.log(`üîÑ Modifying slide ${slideIndex + 1}:`, modificationPrompt);
                console.log('Original slide:', originalSlide);
                console.log('Theme:', theme);
                
                // Call the modify API with COMPLETE slide data including theme
                const response = await fetch('/api/modify-slides', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        slideData: {
                            slides: [originalSlide],
                            designTheme: theme  // Include theme to avoid error
                        },
                        modificationRequest: modificationPrompt,
                        apiKey: '',  // Use backend provider
                        provider: 'bedrock'
                    })
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    let errorMessage = 'Modification failed';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorMessage;
                        console.error('Error data:', errorData);
                    } catch (e) {
                        const errorText = await response.text();
                        console.error('Error text:', errorText);
                        errorMessage = errorText || errorMessage;
                    }
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                console.log('Modification result:', result);
                
                const modifiedSlide = result.slideData?.slides?.[0] || result.slides?.[0];
                
                if (!modifiedSlide) {
                    console.error('Full result:', JSON.stringify(result, null, 2));
                    throw new Error('No modified slide returned from API');
                }
                
                console.log('Modified slide:', modifiedSlide);
                
                // Update ONLY this slide in our data
                window.currentSlideData.slides[slideIndex] = modifiedSlide;
                
                // Update ONLY this slide's preview (not whole deck)
                if (slidePreview) {
                    slidePreview.innerHTML = renderSlideContent(modifiedSlide, theme);
                }
                
                // Clear the prompt
                if (promptTextarea) {
                    promptTextarea.value = '';
                }
                
                alert('‚úÖ Slide modified successfully!');
                console.log('‚úÖ Slide modification complete');
                
            } catch (error) {
                console.error('Modification error:', error);
                console.error('Error stack:', error.stack);
                alert('‚ùå Failed to modify slide: ' + error.message);
                
                // Restore original slide preview
                if (slidePreview) {
                    slidePreview.innerHTML = renderSlideContent(originalSlide, theme);
                }
            }
        }
        
        async function openPDFInNewWindow() {
            if (!sessionId) {
                alert('‚ùå PDF not available - no session ID found.');
                return;
            }
            
            console.log('üìÑ Opening PDF in new window for session:', sessionId);
            
            const pdfUrl = `/view-pdf/${sessionId}`;
            
            try {
                // Check if PDF exists first
                const checkResponse = await fetch(pdfUrl, { method: 'HEAD' });
                
                if (checkResponse.ok) {
                    // PDF exists - open it directly in new window
                    window.open(pdfUrl, '_blank');
                    console.log('‚úÖ PDF opened in new window');
                } else if (checkResponse.status === 404) {
                    // PDF doesn't exist - generate it first
                    if (!confirm('PDF needs to be generated first. This may take up to 30 seconds.\n\nDo you want to generate it now?')) {
                        return;
                    }
                    
                    console.log('‚è≥ Generating PDF...');
                    
                    const generateResponse = await fetch(`/api/convert-to-pdf/${sessionId}`, {
                        method: 'POST'
                    });
                    
                    if (!generateResponse.ok) {
                        const errorData = await generateResponse.json();
                        throw new Error(errorData.error || 'PDF generation failed');
                    }
                    
                    console.log('‚è≥ Waiting for PDF to be written...');
                    
                    // Wait for file to be fully written
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // Verify it's accessible
                    const verifyResponse = await fetch(pdfUrl, { method: 'HEAD' });
                    
                    if (verifyResponse.ok) {
                        // Open in new window
                        window.open(pdfUrl, '_blank');
                        console.log('‚úÖ PDF generated and opened in new window');
                    } else {
                        throw new Error('PDF generated but not accessible. Please try again.');
                    }
                } else {
                    throw new Error(`Unexpected response: ${checkResponse.status}`);
                }
                
            } catch (error) {
                console.error('PDF error:', error);
                alert('‚ùå PDF Error: ' + error.message + '\n\nLibreOffice may not be installed on the server. You can download the PowerPoint file instead.');
            }
        }
        
        // Load on page load
        loadSharedPresentation();
    </script>
</body>
</html>

